"use strict";const e=require("../../../common/vendor.js"),n=require("../config.js"),o=e.er.importObject("uni-id-co"),t=e.er.database().collection("uni-id-users");let i=e.index.getStorageSync("uni-id-pages-userInfo")||{};const s={userInfo:i,hasLogin:0!=Object.keys(i).length},r={async updateUserInfo(n=!1){if(n)t.where("_id==$env.uid").update(n).then((o=>{o.result.updated?(e.index.showToast({title:"更新成功",icon:"none",duration:3e3}),this.setUserInfo(n)):e.index.showToast({title:"没有改变",icon:"none",duration:3e3})}));else{const n=e.er.importObject("uni-id-co",{customUI:!0});try{let e=await t.where("'_id' == $cloudEnv_uid").field("mobile,nickname,username,email,avatar_file").get();const o=await n.getRealNameInfo();this.setUserInfo({...e.result.data[0],realNameAuth:o})}catch(o){this.setUserInfo({},{cover:!0}),console.error(o.message,o.errCode)}}},async setUserInfo(n,{cover:o}={cover:!1}){let t=o?n:Object.assign(a.userInfo,n);return a.userInfo=Object.assign({},t),a.hasLogin=0!=Object.keys(a.userInfo).length,e.index.setStorageSync("uni-id-pages-userInfo",a.userInfo),n},async logout(){if(e.er.getCurrentUserInfo().tokenExpired>Date.now())try{await o.logout()}catch(n){console.error(n)}e.index.removeStorageSync("uni_id_token"),e.index.setStorageSync("uni_id_token_expired",0),e.index.redirectTo({url:`/${e.pagesJson.uniIdRouter&&e.pagesJson.uniIdRouter.loginPage?e.pagesJson.uniIdRouter.loginPage:"uni_modules/uni-id-pages/pages/login/login-withoutpwd"}`}),e.index.$emit("uni-id-pages-logout"),this.setUserInfo({},{cover:!0})},loginBack(n={}){const{uniIdRedirectUrl:o=""}=n;let t=0,i=getCurrentPages();if(i.forEach(((e,n)=>{"login"==i[i.length-n-1].route.split("/")[3]&&t++})),o)return e.index.redirectTo({url:o,fail:n=>{e.index.switchTab({url:o,fail:e=>{console.log(n,e)}})}});if(t){const n=e.pagesJson.pages[0];return e.index.reLaunch({url:`/${n.path}`})}e.index.navigateBack({delta:t})},loginSuccess(o={}){const{showToast:t=!0,toastText:i="登录成功",autoBack:s=!0,uniIdRedirectUrl:r="",passwordConfirmed:a}=o;if(t&&e.index.showToast({title:i,icon:"none",duration:3e3}),this.updateUserInfo(),e.index.$emit("uni-id-pages-login-success"),n.config.setPasswordAfterLogin&&!a)return e.index.redirectTo({url:r?`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?uniIdRedirectUrl=${r}&loginType=${o.loginType}`:`/uni_modules/uni-id-pages/pages/userinfo/set-pwd/set-pwd?loginType=${o.loginType}`,fail:e=>{console.log(e)}});s&&this.loginBack({uniIdRedirectUrl:r})}},a=e.reactive(s),u=Object.freeze(Object.defineProperty({__proto__:null,mutations:r,store:a},Symbol.toStringTag,{value:"Module"}));exports.mutations=r,exports.store=a,exports.uniIdPagesStore=u;
