"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/validator/opendb-app-versions.js"),n=require("../utils.js"),i=e.er.database(),a=i.command,s=["name","title","stable_publish","type"];function o(e={}){return{create_env:a.neq("uni-stat"),...e}}const p={data:()=>({backButtonHover:!1,appVersionListDbName:n.appVersionListDbName,currentAppid:"",currentAppName:"",query:"",where:"",orderby:"stable_publish desc,create_date desc",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,...t.enumConverter},imageStyles:{width:64,height:64},loaded:!1,containerTop:{},appList:[],showAppIndex:0}),async onLoad({appid:e}){await this.getAppList(),this.appList.length?(this.loaded=!0,this.appList.forEach(((t,i)=>{(t.appid===e||n.defaultDisplayApp)&&(this.showAppIndex=i)})),this.setAppInfo(this.showAppIndex),this.where=o({appid:this.currentAppid})):this.showModalToAppManager()},computed:{...e.mapState("app",["appid"]),appNameList(){return this.appList.map((e=>e.name))}},watch:{showAppIndex(e){this.setAppInfo(e),this.where=o({appid:this.currentAppid})}},onReady(){this.containerTop.height=`${document.documentElement?document.documentElement.clientHeight:window.innerHeight}px`},methods:{setAppInfo(e){this.currentAppid=this.appList[e].appid,this.currentAppName=this.appList[e].name},navigateBack(){e.index.navigateBack()},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return s.map((e=>t+".test("+e+")")).join(" || ")},search(){const e=this.getWhere(),t=e===this.where;this.where=e,this.where&&(this.where=`(${this.where}) && `),this.where+=`${new RegExp(this.currentAppid,"i")}.test(appid)`,t&&this.loadData()},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.$refs.udb.loadData({current:e.current})},navigateTo(t,n){e.index.navigateTo({url:t,events:{refreshData:()=>{this.loadData(n)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems())},selectionChange(e){this.selectedIndexs=e.detail.index},confirmDelete(e){this.$refs.udb.remove(e)},publish(t){const n=Object.keys(this.options.type_valuetotext);e.index.showActionSheet({itemList:Object.values(this.options.type_valuetotext),success:async e=>{this.navigateTo(`./add?appid=${this.currentAppid}&name=${this.currentAppName}&type=${n[e.tapIndex]}`)}})},async getAppList(){try{const{result:e}=await i.collection(n.appListDbName).get();e&&e.data&&e.data.length>0?this.appList=e.data.filter((e=>e.appid!==this.appid)):this.showModalToAppManager()}catch(e){-1===["TOKEN_INVALID_TOKEN_EXPIRED","TOKEN_INVALID_ANONYMOUS_USER"].indexOf(e.code)&&this.showModalToAppManager()}},showModalToAppManager(){let t=null,n=3;function i(){e.index.navigateTo({url:"/pages/system/app/list"}),clearInterval(t)}t=setInterval((()=>{--n<=0&&i()}),1e3),e.index.showModal({title:"请先添加应用",content:"即将跳转至应用管理……",showCancel:!1,confirmText:"立即跳转",success:e=>i()})},store_list_key(e){const t=e?e.filter((e=>e.enable)):[];return t.length?t.sort(((e,t)=>t.priority-e.priority)).map((e=>e.name)).join(","):"-"}}};if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-data-picker")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("unicloud-db"))()}Math||((()=>"../../../uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../uni-table/components/uni-th/uni-th.js")+(()=>"../../../uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../uni-table/components/uni-td/uni-td.js")+(()=>"../../../uni-data-picker/components/uni-data-picker/uni-data-picker.js")+(()=>"../../../uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../../uni-table/components/uni-table/uni-table.js")+(()=>"../../../uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js"))();const r=e._export_sfc(p,[["render",function(t,n,i,a,s,o){return e.e({a:s.loaded},s.loaded?{b:e.t(o.appNameList[s.showAppIndex]),c:e.p({type:"bottom"}),d:e.o((e=>s.showAppIndex=e.detail.value)),e:s.showAppIndex,f:o.appNameList,g:e.o(((...e)=>o.search&&o.search(...e))),h:s.query,i:e.o((e=>s.query=e.detail.value)),j:e.o(((...e)=>o.search&&o.search(...e))),k:e.o(((...e)=>o.publish&&o.publish(...e))),l:!s.selectedIndexs.length,m:e.o(((...e)=>o.delTable&&o.delTable(...e))),n:e.w((({data:t,pagination:n,loading:i,error:a,options:s},p,r)=>({a:"e867c2be-4-"+r+",e867c2be-3-"+r,b:"e867c2be-5-"+r+",e867c2be-3-"+r,c:"e867c2be-6-"+r+",e867c2be-3-"+r,d:"e867c2be-7-"+r+",e867c2be-3-"+r,e:"e867c2be-8-"+r+",e867c2be-3-"+r,f:"e867c2be-9-"+r+",e867c2be-3-"+r,g:"e867c2be-10-"+r+",e867c2be-3-"+r,h:"e867c2be-11-"+r+",e867c2be-3-"+r,i:"e867c2be-12-"+r+",e867c2be-3-"+r,j:"e867c2be-3-"+r+",e867c2be-2-"+r,k:e.f(t,((t,n,i)=>({a:e.t(t.appid),b:"e867c2be-14-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,c:e.t(t.title||"-"),d:"e867c2be-15-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,e:e.t(s.type_valuetotext[t.type]),f:"wgt"===t.type?"#f0f9eb":"#ecf5ff",g:"wgt"===t.type?"#67c23a":"#409eff",h:"1px solid "+("wgt"===t.type?"#e1f3d8":"#d9ecff"),i:"e867c2be-16-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,j:"e867c2be-18-"+r+"-"+i+",e867c2be-17-"+r+"-"+i,k:e.p({localdata:s.platform_valuetotext,value:t.platform,border:!1,readonly:!0,split:","}),l:"e867c2be-17-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,m:e.t(o.store_list_key(t.store_list)),n:"e867c2be-19-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,o:e.t(t.version),p:"e867c2be-20-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,q:e.t(1==t.stable_publish?"已上线":"已下线"),r:"e867c2be-21-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,s:"e867c2be-23-"+r+"-"+i+",e867c2be-22-"+r+"-"+i,t:e.p({format:"yyyy-MM-dd hh:mm:ss",date:t.create_date,threshold:[0,0]}),v:"e867c2be-22-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,w:e.o((e=>o.navigateTo("./detail?id="+t._id,!1)),n),x:"e867c2be-24-"+r+"-"+i+",e867c2be-13-"+r+"-"+i,y:n,z:"e867c2be-13-"+r+"-"+i+",e867c2be-2-"+r,A:e.p({disabled:t.stable_publish})}))),l:"e867c2be-2-"+r+",e867c2be-1",m:e.p({loading:i,emptyText:a.message||"没有更多数据",border:!0,stripe:!0,type:"selection"}),n:"e867c2be-25-"+r+",e867c2be-1",o:e.o((e=>n.current=e)),p:e.p({"show-icon":!0,"page-size":n.size,total:n.count,modelValue:n.current}),q:r,r:p})),{name:"d",path:"n",vueId:"e867c2be-1"}),o:e.p({align:"center"}),p:e.p({align:"center"}),q:e.p({align:"center"}),r:e.p({align:"center"}),s:e.p({align:"center"}),t:e.p({align:"center"}),v:e.p({align:"center"}),w:e.p({align:"center"}),x:e.p({align:"center"}),y:e.p({align:"center"}),z:e.p({align:"center"}),A:e.p({align:"center"}),B:e.p({align:"center"}),C:e.p({align:"center"}),D:e.p({align:"center"}),E:e.p({align:"center"}),F:e.p({align:"center"}),G:e.p({align:"center"}),H:e.o(o.selectionChange),I:e.o(o.onPageChanged),J:e.sr("udb","e867c2be-1"),K:e.p({collection:s.appVersionListDbName,field:"store_list,appid,contents,platform,type,version,min_uni_version,url,stable_publish,create_date,title,name",where:s.where,"page-data":"replace",orderby:s.orderby,getcount:!0,"page-size":s.options.pageSize,"page-current":s.options.pageCurrent,options:s.options})}:{L:e.s(s.containerTop)})}]]);wx.createPage(r);
