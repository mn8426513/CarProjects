"use strict";const e=require("../../../../common/vendor.js"),a=require("../mixin/version_add_detail_mixin.js"),t=require("../utils.js"),i=e.er.database();i.command;const o=t.appVersionListDbName,s={mixins:[a.addAndDetail],data:()=>({latestVersion:"0.0.0",lastVersionId:"",uniFilePickerProvider:"unicloud",domain:""}),async onLoad({appid:e,name:t,type:i}){let{domain:o,provider:s}=this.getCloudStorageConfig();if(o&&(this.domain=o),s&&(this.uniFilePickerProvider=s),e&&i&&t){const o=await this.getStoreList(e);this.formData={...this.formData,appid:e,name:t,type:i,store_list:o},this.latestStableData=await this.getDetail(e,i),!this.isWGT&&this.latestStableData.length&&this.setFormData(a.platform_Android),this.isWGT&&this.rules.min_uni_version.rules.push({required:!0})}},onUnload(){this.setCloudStorage({provider:null})},watch:{isiOS(e){e||!this.hasPackage?this.formData.url="":this.formData.url=this.appFileList.url},"formData.platform"(e){this.setFormData(e)},domain(e){this.setCloudStorage({domain:e}),this.formData.url&&(e||(e="请输入自定义域名"),this.formData.url=this.formData.url.replace(/^(https?:\/\/)[^\/]+/,`$1${e}`))},uniFilePickerProvider:{immediate:!0,handler(e){this.setCloudStorage({provider:e})}}},methods:{setFormData(a){e.index.showLoading({mask:!0}),this.latestVersion="0.0.0",this.lastVersionId="";const t=this.getData(this.latestStableData,a)[0];if(t){const{_id:e,version:a,name:i,platform:o,min_uni_version:s,url:l}=t;this.lastVersionId=e,this.latestVersion=a,this.formData.name=i,this.isWGT?this.formData.min_uni_version=s:(delete this.formData.min_uni_version,this.formData.platform=o[0],(this.isiOS||this.isHarmony)&&(this.formData.url=l))}else this.isWGT&&(this.formData.min_uni_version="");e.index.hideLoading()},submit(){e.index.showLoading({mask:!0}),this.$refs.form.validate(["store_list"]).then((a=>{if(t.compare(this.latestVersion,a.version)>=0)throw e.index.showModal({content:`版本号必须大于当前已上线版本（${this.latestVersion}）`,showCancel:!1}),new Error("版本号必须大于已上线版本（${this.latestVersion}）");this.isWGT||(a.platform=[a.platform]),(this.isiOS||this.isHarmony||this.isWGT)&&delete a.store_list,a.store_list&&a.store_list.forEach((e=>{e.priority=parseFloat(e.priority)})),this.submitForm(a)})).catch((a=>{e.index.hideLoading()}))},async submitForm(a){a=this.createCenterRecord(a);const t=i.collection(o);let s,l=[];this.isWGT||(l=await this.getDetail(a.appid,a.type,this.createStatQuery(a))),l.length?(a.create_date=Date.now(),s=t.doc(l[0]._id).update(a)):s=t.add(a),s.then((async i=>{a.stable_publish&&this.lastVersionId&&await t.doc(this.lastVersionId).update({stable_publish:!1}),e.index.showToast({title:"新增成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()})),this.setCloudStorageConfig({provider:this.uniFilePickerProvider,domain:this.domain})},getDetail:(t,s,l={})=>(e.index.showLoading({mask:!0}),i.collection(o).where(Object.assign({appid:t,type:s,stable_publish:!0},l)).field(a.fields).get().then((e=>e.result.data)).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))),getData:(e=[],a)=>"string"==typeof a?e.filter((e=>e.platform.includes(a))):e.filter((e=>e.platform.toString()===a.toString())),back(){e.index.showModal({title:"取消发布",content:this.hasPackage?"将会删除已上传的包":void 0,success:a=>{a.confirm&&(this.hasPackage&&this.deleteFile([this.appFileList.url]),e.index.navigateBack())}})}}};if(!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("show-info")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-card")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../../uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../../uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../../../components/show-info/show-info.js")+(()=>"../../../uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../uni-card/components/uni-card/uni-card.js")+(()=>"../../../uni-forms/components/uni-forms/uni-forms.js"))();const l=e._export_sfc(s,[["render",function(a,t,i,o,s,l){return e.e({a:e.t(a.type_valuetotext[a.formData.type]),b:e.o((e=>a.formData.appid=e)),c:e.p({disabled:!0,trim:"both",modelValue:a.formData.appid}),d:e.p({name:"appid",label:"AppID",required:!0}),e:e.o((e=>a.formData.name=e)),f:e.p({disabled:!0,trim:"both",modelValue:a.formData.name}),g:e.p({name:"name",label:"应用名称"}),h:e.o((e=>a.formData.title=e)),i:e.p({placeholder:"更新标题",modelValue:a.formData.title}),j:e.p({name:"title",label:"更新标题"}),k:-1,l:e.o((e=>a.binddata("contents",e.detail.value))),m:a.formData.contents,n:e.o((e=>a.formData.contents=e)),o:e.p({name:"contents",label:"更新内容",required:!0}),p:e.o((e=>a.formData.platform=e)),q:e.p({multiple:a.isWGT,localdata:a.platformLocaldata,modelValue:a.formData.platform}),r:e.p({name:"platform",label:"平台",required:!0}),s:e.o((e=>a.formData.version=e)),t:e.p({placeholder:"当前包版本号，必须大于当前线上发行版本号",modelValue:a.formData.version}),v:e.p({name:"version",label:"版本号",required:!0}),w:a.isWGT},a.isWGT?{x:e.o((e=>a.formData.min_uni_version=e)),y:e.p({placeholder:"原生App最低版本",modelValue:a.formData.min_uni_version}),z:e.p({content:a.minUniVersionContent}),A:e.p({name:"min_uni_version",label:"原生App最低版本",required:a.isWGT})}:{},{B:a.enableUploadPackage},a.enableUploadPackage?e.e({C:"unicloud"===s.uniFilePickerProvider,D:"extStorage"===s.uniFilePickerProvider,E:e.o((e=>s.uniFilePickerProvider=e.detail.value)),F:e.o((e=>a.toUrl("https://doc.dcloud.net.cn/uniCloud/ext-storage/service.html"))),G:e.p({label:"存储选择"}),H:"extStorage"===s.uniFilePickerProvider},"extStorage"===s.uniFilePickerProvider?{I:e.o((e=>s.domain=e)),J:e.p({placeholder:"请输入扩展存储自定义域名",maxlength:-1,modelValue:s.domain}),K:e.p({label:"自定义域名"})}:{},{L:e.o(((...e)=>a.selectFile&&a.selectFile(...e))),M:e.t(a.fileExtname[0]),N:e.o(a.packageUploadSuccess),O:e.o(a.packageDelete),P:e.o((e=>a.appFileList=e)),Q:e.p({"file-extname":a.fileExtname,disabled:a.hasPackage,returnType:"object","file-mediatype":"all",limit:"1",provider:s.uniFilePickerProvider,modelValue:a.appFileList}),R:a.hasPackage},a.hasPackage?{S:e.t(Number(a.appFileList.size/1024/1024).toFixed(2))}:{},{T:e.p({label:"上传"+a.fileExtname[0]+"包"})}):{},{U:e.o((e=>a.formData.url=e)),V:e.p({placeholder:"链接",maxlength:-1,modelValue:a.formData.url}),W:a.isApk},a.isApk?{X:e.o((e=>a.toUrl(a.formData.url)))}:{},{Y:a.isApk},(a.isApk,{}),{Z:e.p({name:"url",label:a.urlLabel,required:!0}),aa:a.isAndroid&&!a.isWGT&&a.formData.store_list.length},a.isAndroid&&!a.isWGT&&a.formData.store_list.length?{ab:e.f(a.formData.store_list,((a,t,i)=>({a:a.enable,b:e.o((({detail:{value:e}})=>{a.enable=!!e.length}),a.id),c:"0ffa3eee-25-"+i+",0ffa3eee-24-"+i,d:e.o((e=>a.name=e),a.id),e:e.p({disabled:!0,trim:"both",modelValue:a.name}),f:"0ffa3eee-24-"+i+",0ffa3eee-23-"+i,g:"0ffa3eee-27-"+i+",0ffa3eee-26-"+i,h:e.o((e=>a.scheme=e),a.id),i:e.p({disabled:!0,trim:"both",modelValue:a.scheme}),j:"0ffa3eee-26-"+i+",0ffa3eee-23-"+i,k:"0ffa3eee-29-"+i+",0ffa3eee-28-"+i,l:e.o((e=>a.priority=e),a.id),m:e.p({type:"number",modelValue:a.priority}),n:"0ffa3eee-30-"+i+",0ffa3eee-28-"+i,o:"0ffa3eee-28-"+i+",0ffa3eee-23-"+i,p:"0ffa3eee-23-"+i+",0ffa3eee-22",q:a.id}))),ac:e.p({label:"商店名称"}),ad:e.p({label:"Scheme"}),ae:e.p({top:-100,left:-180,content:a.priorityContent}),af:e.p({label:"优先级"}),ag:e.p({label:"Android应用市场",labelWidth:"125px",name:"store_list"})}:{},{ah:a.isWGT},a.isWGT?{ai:e.o((e=>a.binddata("is_silently",e.detail.value))),aj:a.formData.is_silently,ak:e.p({top:-80,content:a.silentlyContent}),al:e.p({name:"is_silently",label:"静默更新"})}:{},{am:e.o((e=>a.binddata("is_mandatory",e.detail.value))),an:a.formData.is_mandatory,ao:e.p({content:a.mandatoryContent}),ap:e.p({name:"is_mandatory",label:"强制更新"}),aq:e.o((e=>a.binddata("stable_publish",e.detail.value))),ar:a.formData.stable_publish,as:e.p({top:-40,content:a.stablePublishContent2}),at:e.p({name:"stable_publish",label:"上线发行"}),av:e.o((e=>a.formData.type=e)),aw:e.p({localdata:a.formOptions.type_localdata,modelValue:a.formData.type}),ax:e.p({name:"type",label:"安装包类型"}),ay:e.o(((...e)=>l.submit&&l.submit(...e))),az:e.o(((...e)=>l.back&&l.back(...e))),aA:e.sr("form","0ffa3eee-0"),aB:e.p({value:a.formData,validateTrigger:"bind",labelWidth:a.labelWidth})})}]]);wx.createPage(l);
