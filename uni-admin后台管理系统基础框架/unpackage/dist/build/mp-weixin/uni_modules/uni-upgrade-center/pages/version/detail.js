"use strict";const e=require("../../../../common/vendor.js"),a=require("../mixin/version_add_detail_mixin.js"),t=require("../utils.js"),i=e.er.database();i.command;const o=t.appVersionListDbName,l={mixins:[a.addAndDetail],data:()=>({showStableInfo:!1,isStable:!0,originalData:{},detailsState:!0,uniFilePickerProvider:"unicloud",domain:""}),async onLoad(e){let{domain:a,provider:t}=this.getCloudStorageConfig();a&&(this.domain=a),t&&(this.uniFilePickerProvider=t);const i=e.id;this.formDataId=i,await this.getDetail(i),this.isStable=this.formData.stable_publish,this.latestStableData=await this.getLatestVersion(),this.isWGT&&this.rules.min_uni_version.rules.push({required:!0})},onUnload(){this.setCloudStorage({provider:null})},watch:{domain(e){this.setCloudStorage({domain:e}),this.formData.url&&(e||(e="请输入自定义域名"),this.formData.url=this.formData.url.replace(/^(https?:\/\/)[^\/]+/,`$1${e}`))},uniFilePickerProvider(e){this.setCloudStorage({provider:e})}},methods:{submit(){e.index.showLoading({mask:!0}),this.$refs.form.validate(["store_list"]).then((e=>{e.store_list&&e.store_list.forEach((e=>{e.priority=parseFloat(e.priority)})),this.submitForm(e)})).catch((a=>{e.index.hideLoading()}))},async submitForm(a){const t=i.collection(o);t.doc(this.formDataId).update(a).then((async i=>{!this.isStable&&!0===a.stable_publish&&this.latestStableData&&await t.doc(this.latestStableData._id).update({stable_publish:!1}),e.index.showToast({title:"修改成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},getDetail(l){return e.index.showLoading({mask:!0}),i.collection(o).doc(l).field(a.fields).get().then((e=>{const a=e.result.data[0];a&&(a.store_list||(a.store_list=[]),this.formData=a,this.originalData=t.deepClone(this.formData))})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},deletePackage(){e.index.showModal({title:"提示",content:"是否删除该版本",success:a=>{a.confirm&&(e.index.showLoading({mask:!0}),i.collection(o).doc(this.formDataId).remove().then((()=>{e.index.showToast({title:"删除成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((a=>{e.index.showModal({content:a.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()})))}})},async getLatestVersion(){const e={appid:this.formData.appid,type:this.formData.type,stable_publish:!0};this.isWGT||(e.platform=this.formData.platform[0]);return(await i.collection(o).where(e).get()).result.data.find((e=>e.platform.toString()===this.formData.platform.toString()))},cancelEdit(){let a="";!this.isiOS&&this.hasPackage&&(a+="\n将会删除已上传的包"),e.index.showModal({title:"取消修改",content:a,success:e=>{e.confirm&&(this.formData=t.deepClone(this.originalData),this.detailsState=!0,this.hasPackage&&this.deleteFile([this.appFileList.url]))}})}}};if(!Array){(e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("show-info")+e.resolveComponent("uni-file-picker")+e.resolveComponent("uni-card")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../../uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../../uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../../../components/show-info/show-info.js")+(()=>"../../../uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../uni-card/components/uni-card/uni-card.js")+(()=>"../../../uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../../uni-forms/components/uni-forms/uni-forms.js"))();const s=e._export_sfc(l,[["render",function(a,t,i,o,l,s){return e.e({a:e.t(a.type_valuetotext[a.formData.type]),b:!l.isStable},l.isStable?{}:{c:e.o(((...e)=>s.deletePackage&&s.deletePackage(...e)))},{d:e.o((e=>a.formData.appid=e)),e:e.p({disabled:!0,trim:"both",modelValue:a.formData.appid}),f:e.p({name:"appid",label:"AppID",required:!0}),g:e.o((e=>a.formData.name=e)),h:e.p({disabled:!0,trim:"both",modelValue:a.formData.name}),i:e.p({name:"name",label:"应用名称"}),j:e.o((e=>a.formData.title=e)),k:e.p({disabled:l.detailsState,placeholder:"更新标题",modelValue:a.formData.title}),l:e.p({name:"title",label:"更新标题"}),m:l.detailsState,n:e.o((e=>a.binddata("contents",e.detail.value))),o:a.formData.contents,p:e.o((e=>a.formData.contents=e)),q:e.p({name:"contents",label:"更新内容",required:!0}),r:e.o((e=>a.formData.platform=e)),s:e.p({disabled:!0,multiple:a.isWGT,localdata:a.platformLocaldata,modelValue:a.formData.platform}),t:e.p({name:"platform",label:"平台",required:!0}),v:e.o((e=>a.formData.version=e)),w:e.p({disabled:!0,placeholder:"当前包版本号，必须大于当前已上线版本号",modelValue:a.formData.version}),x:e.p({name:"version",label:"版本号",required:!0}),y:a.isWGT},a.isWGT?{z:e.o((e=>a.formData.min_uni_version=e)),A:e.p({disabled:l.detailsState,placeholder:"原生App最低版本",modelValue:a.formData.min_uni_version}),B:e.p({content:a.minUniVersionContent}),C:e.p({name:"min_uni_version",label:"原生App最低版本",required:a.isWGT})}:{},{D:a.enableUploadPackage&&!l.detailsState},a.enableUploadPackage&&!l.detailsState?e.e({E:"unicloud"===l.uniFilePickerProvider,F:"extStorage"===l.uniFilePickerProvider,G:e.o((e=>l.uniFilePickerProvider=e.detail.value)),H:e.o((e=>a.toUrl("https://doc.dcloud.net.cn/uniCloud/ext-storage/service.html"))),I:e.p({label:"存储选择"}),J:"extStorage"===l.uniFilePickerProvider},"extStorage"===l.uniFilePickerProvider?{K:e.o((e=>l.domain=e)),L:e.p({placeholder:"请输入扩展存储自定义域名",maxlength:-1,modelValue:l.domain}),M:e.p({label:"自定义域名"})}:{},{N:e.o(((...e)=>a.selectFile&&a.selectFile(...e))),O:e.o(a.packageUploadSuccess),P:e.o(a.packageDelete),Q:e.o((e=>a.appFileList=e)),R:e.p({"file-extname":a.fileExtname,disabled:a.hasPackage,returnType:"object","file-mediatype":"all",limit:"1",provider:l.uniFilePickerProvider,modelValue:a.appFileList}),S:a.hasPackage},a.hasPackage?{T:e.t(Number(a.appFileList.size/1024/1024).toFixed(2))}:{},{U:e.p({label:"上传"+a.fileExtname[0]+"包"})}):{},{V:e.o((e=>a.formData.url=e)),W:e.p({disabled:l.detailsState,placeholder:"下载链接",maxlength:-1,modelValue:a.formData.url}),X:a.formData.url},a.formData.url?{Y:e.o((e=>a.toUrl(a.formData.url)))}:{},{Z:a.formData.url&&!l.detailsState},(a.formData.url&&l.detailsState,{}),{aa:e.p({name:"url",label:a.urlLabel,required:!0}),ab:a.isAndroid&&!a.isWGT&&a.formData.store_list.length},a.isAndroid&&!a.isWGT&&a.formData.store_list.length?{ac:e.f(a.formData.store_list,((a,t,i)=>({a:a.enable,b:e.o((({detail:{value:e}})=>{a.enable=!!e.length}),a.id),c:"96a4f3d8-25-"+i+",96a4f3d8-24-"+i,d:e.o((e=>a.name=e),a.id),e:e.p({disabled:!0,trim:"both",modelValue:a.name}),f:"96a4f3d8-24-"+i+",96a4f3d8-23-"+i,g:"96a4f3d8-27-"+i+",96a4f3d8-26-"+i,h:e.o((e=>a.scheme=e),a.id),i:e.p({disabled:!0,trim:"both",modelValue:a.scheme}),j:"96a4f3d8-26-"+i+",96a4f3d8-23-"+i,k:"96a4f3d8-29-"+i+",96a4f3d8-28-"+i,l:e.o((e=>a.priority=e),a.id),m:e.p({disabled:l.detailsState,type:"number",modelValue:a.priority}),n:"96a4f3d8-30-"+i+",96a4f3d8-28-"+i,o:"96a4f3d8-28-"+i+",96a4f3d8-23-"+i,p:"96a4f3d8-23-"+i+",96a4f3d8-22",q:a.id}))),ad:l.detailsState,ae:e.p({label:"商店名称"}),af:e.p({label:"Scheme"}),ag:e.p({top:-100,left:-180,content:a.priorityContent}),ah:e.p({label:"优先级"}),ai:e.p({label:"Android应用市场",name:"store_list",labelWidth:"120"})}:{},{aj:a.isWGT},a.isWGT?{ak:l.detailsState,al:e.o((e=>(a.binddata("is_silently",e.detail.value),a.formData.is_silently=e.detail.value))),am:a.formData.is_silently,an:e.p({top:-80,content:a.silentlyContent}),ao:e.p({name:"is_silently",label:"静默更新"})}:{},{ap:l.detailsState,aq:e.o((e=>(a.binddata("is_mandatory",e.detail.value),a.formData.is_mandatory=e.detail.value))),ar:a.formData.is_mandatory,as:e.p({width:"230",top:-30,content:a.mandatoryContent}),at:e.p({name:"is_mandatory",label:"强制更新"}),av:l.detailsState||l.isStable,aw:e.o((e=>(a.binddata("stable_publish",e.detail.value),a.formData.stable_publish=e.detail.value))),ax:a.formData.stable_publish,ay:l.isStable},l.isStable?{az:e.p({top:-50,width:"350",content:a.stablePublishContent})}:{aA:e.p({top:-40,content:a.stablePublishContent2})},{aB:e.p({name:"stable_publish",label:"上线发行"}),aC:e.p({format:"yyyy-MM-dd hh:mm:ss",date:a.formData.create_date,threshold:[0,0]}),aD:e.p({name:"create_date",label:"上传时间"}),aE:e.o((e=>a.formData.type=e)),aF:e.p({localdata:a.formOptions.type_localdata,modelValue:a.formData.type}),aG:e.p({name:"type",label:"安装包类型"}),aH:l.detailsState},l.detailsState?{aI:e.o((e=>l.detailsState=!1))}:{},{aJ:!l.detailsState},l.detailsState?{}:{aK:e.o(((...e)=>s.submit&&s.submit(...e)))},{aL:!l.detailsState},l.detailsState?{}:{aM:e.o(((...e)=>s.cancelEdit&&s.cancelEdit(...e)))},{aN:e.sr("form","96a4f3d8-0"),aO:e.p({value:a.formData,validateTrigger:"bind",labelWidth:a.labelWidth})})}]]);wx.createPage(s);
