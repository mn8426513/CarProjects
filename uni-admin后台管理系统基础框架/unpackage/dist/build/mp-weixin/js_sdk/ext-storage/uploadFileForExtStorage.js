"use strict";const e=require("../../common/vendor.js");const t={init:function(t={}){let{provider:o}=t,l=o,n=new i(t);const s=e.er.uploadFile;e.er.uploadFile=(...e)=>{let t=e[0]||{},{provider:i=o}=t;return"extStorage"===i?n.uploadFile(...e):s(...e)};const f=e.er.getTempFileURL;e.er.getTempFileURL=(...e)=>{let t=e[0]||{},{provider:i=o}=t;return"extStorage"===i?n.getTempFileURL(...e):f(...e)};const c=e.er.deleteFile;e.er.deleteFile=(...e)=>{let t=e[0]||{},{provider:i=o}=t;return"extStorage"===i?n.deleteFile(...e):c(...e)},e.er.setCloudStorage=(e={})=>{let{provider:t,domain:i,fileID2fileURL:s}=e;null===t?o=l:t&&(o=t),i&&(n.domain=i),s&&(n.fileID2fileURL=s)}}};class i{constructor(e={}){let{uploadFileOptions:t,domain:i,fileID2fileURL:o}=e;this.uploadFileOptions=t,this.domain=i,this.fileID2fileURL=o}uploadFile(t){let{filePath:i,cloudPath:o}=t;const l=new Promise((async(l,n)=>{try{const s=await this.uploadFileOptions({cloudPath:o,domain:this.domain});e.index.uploadFile({...s.uploadFileOptions,filePath:i,success:e=>{if(200!==e.statusCode){const i=e;"function"==typeof t.fail&&t.fail(i),n(i)}else{const e={cloudPath:s.cloudPath,fileID:s.fileID,fileURL:s.fileURL};this.fileID2fileURL&&(e.fileID=`https://${this.domain}/${e.cloudPath}`),"function"==typeof t.success&&t.success(e),l(e)}},fail:e=>{"function"==typeof t.fail&&t.fail(e),n(e)},complete:()=>{"function"==typeof t.complete&&t.complete()}}).onProgressUpdate((e=>{if("function"==typeof t.onUploadProgress){const i=e.totalBytesExpectedToSend,o=e.totalBytesSent,l=Math.round(100*o/i);t.onUploadProgress({total:i,loaded:o,progress:l})}}))}catch(s){"function"==typeof t.fail&&t.fail(s),n(s),"function"==typeof t.complete&&t.complete()}}));return l.catch((()=>{})),l}getTempFileURL(e={}){let{fileList:t}=e;return new Promise(((i,o)=>{let l={fileList:t.map(((e,t)=>{let i=function(e){const t="qiniu://";if(0===e.indexOf(t))e=e.substring(t.length);else if(0===e.indexOf("http://")||0===e.indexOf("https://")){let t=e.indexOf("://")+3;t=e.indexOf("/",t);let i=-1===e.indexOf("?")?e.length:e.indexOf("?");i=-1!==e.indexOf("#")&&e.indexOf("#")<i?e.indexOf("#"):i,e=e.substring(t+1,i)}return e}(e);return{fileID:e,tempFileURL:`https://${this.domain}/${i}`}}))};"function"==typeof e.success&&e.success(l),i(l),"function"==typeof e.complete&&e.complete()}))}deleteFile(e={}){return new Promise(((t,i)=>{let o={fileList:[]};"function"==typeof e.success&&e.success(o),t(o),"function"==typeof e.complete&&e.complete()}))}}exports.uploadFileForExtStorage=t;
