"use strict";const e=require("../../common/vendor.js");function t(e,t=!1,r=[]){const n=[],i=Object.keys(e),o=e.start_time;i.forEach((i=>{if("time_range"===i||-1!==r.indexOf(i))return;let s=e[i];if(s)if("string"==typeof s&&s.indexOf(i)>-1)n.push(s);else if("string"==typeof s&&(s=`"${s}"`),Array.isArray(s))2===s.length&&i.indexOf("time")>-1?n.push(`${i} >= ${s[0]} && ${i} <= ${s[1]}`):(s=s.map((e=>`${i} == "${e}"`)).join(" || "),s&&n.push(`(${s})`));else if(t&&"dimension"===i)if(a(o))n.push('dimension == "hour"');else{let e=getCurrentPages(),t=e[e.length-1];["pages/uni-stat/device/trend/trend","pages/uni-stat/user/trend/trend"].indexOf(t.route)>-1||s&&'"hour"'!==s?n.push(`${i} == ${s}`):n.push('dimension == "day"')}else n.push(`${i} == ${s}`)}));return n.join(" && ")||{}}function r(e,t){return t?e/t:0}function n(e,t=",",r){if("number"!=typeof e)return e;if("%"===t)return e*=100,String(e).indexOf(".")>-1&&(e=e.toFixed(2)),e=e?e+t:e;if("%%"===t)return(e=Number(e)).toFixed(2)+"%";if("-"===t)return i(e,"day");if(":"===t){let r,n,i;e=Math.ceil(e),r=n=i=0;const o=3600,s=60;if(e>=o){r=Math.floor(e/o);const t=e%o;t>=s?(n=Math.floor(t/s),i=t%s):i=t}else o>=e&&e>=s?(n=Math.floor(e/s),i=e%s):i=e;return[r,n,i].map((e=>e<10?"0"+e:e)).join(t)}return","===t?e.toLocaleString():(String(e).indexOf(".")>-1&&(e=Math.abs(e)>1?e.toFixed(r||0):e.toFixed(r||2)),e)}function i(e,t){let r=new Date(e);if("hour"===t){let e=r.getHours();e=e<10?"0"+e:e;let t=`${e}:00 ~ ${e}:59`;if("00"===e){t=o(r)+"（00:00 ~ 00:59）"}return t}if("week"===t){const e=r.getDate()-r.getDay()+1,t=e+6;let n=new Date(r.setDate(e));n=o(n);let i=new Date(r.setDate(t));return i=o(i),`${n} ~ ${i}`}if("month"===t){let e=new Date(r.getFullYear(),r.getMonth(),1);e=o(e);let t=new Date(r.getFullYear(),r.getMonth()+1,0);return t=o(t),`${e} ~ ${t}`}return o(r)}function o(e,t,r="-"){let n=e;"object"!=typeof n&&(n=new Date(n));const i=n.getFullYear(),o=n.getMonth()+1,a=n.getDate(),f=n.getHours(),l=n.getMinutes(),u=n.getSeconds(),p=[i,s(o),s(a)].join(r),m=[s(f),s(l),s(u)].join(":");return"dateTime"===t?p+" "+m:p}function s(e){return e<10?"0"+e:e}function a(e,t=2){if(!e.length)return!0;const[r,n]=e;return n-r<864e5*t}exports.debounce=function(e,t=100){let r=null;return function(...n){r&&clearTimeout(r),r=setTimeout((()=>{e.apply(this,n)}),t)}},exports.fillTrendChartData=function(e,t,r){let{start_time:n,dimension:i}=t;if(["hour","day"].indexOf(i)>-1){let t,o=[];"hour"===i?t=36e5:"day"===i&&(t=864e5);let s=n[0],a=n[1],f=s;for(o=[s];f+t<=a;)f+=t,o.push(f);let l=[];for(let n=0;n<o.length;n++){let t=o[n],i=e.find(((e,r)=>e.start_time===t));if(i)l.push(i);else{let e={start_time:t};r.map(((t,r)=>{e[t.field]=0})),l.push(e)}}return l}return e},exports.format=n,exports.formatDate=i,exports.formatterData=function(e){let{fieldsMap:t,data:r,formatter:n=!0}=e,i=JSON.parse(JSON.stringify(r));return i.map((e=>{for(let i in e){let s=t.find((e=>e.field==i));if("object"==typeof s){let{fix:t=0}=s;"number"==typeof s.multiple&&"number"==typeof e[i]&&(e[i]=Number((e[i]*s.multiple).toFixed(t))),n&&s.formatter&&"number"==typeof e[i]&&(","===s.formatter?e[i]=(r=e[i],String(r).replace(/\B(?=(\d{3})+(?!\d))/g,",")):"%"===s.formatter?e[i]=`${(100*e[i]).toFixed(t)}%`:"-"===s.formatter&&(e[i]=o(e[i])))}}var r})),i},exports.getAllDateCN=function(e,t){let r=[],n=0;for(;t.getTime()-e.getTime()>=0;)r[n]=e.getTime(),e.setDate(e.getDate()+1),n+=1;return r},exports.getFieldTotal=function(r=this.query,i="total_devices"){let o;return"object"==typeof r&&(r=t(r,!1,["uni_platform"])),e.er.database().collection("uni-stat-result").where(r).field(`${i} as temp_${i}, start_time`).groupBy("start_time").groupField(`sum(temp_${i}) as ${i}`).orderBy("start_time","desc").get().then((e=>{const t=e.result.data;return o=t.length&&t[0][i],o=n(o),this.panelData&&this.panelData.forEach((e=>{e.field===i&&(e.value=o)})),Promise.resolve(o)}))},exports.getTimeOfSomeDayAgo=function(e=0,t=Date.now()){const r=new Date(t);let n=[r.getFullYear(),r.getMonth()+1,r.getDate()].join("/");return n+=" 00:00:00",new Date(n).getTime()-864e5*e},exports.mapfields=function(e,t={},i,o="",s="value"){const a=[],f=i;e=JSON.parse(JSON.stringify(e));const l=JSON.parse(JSON.stringify(t));for(const u of e){let{field:e,computed:p,formatter:m,disable:d,fix:c}=u;if(!d){const d=(i=f||u).hasOwnProperty(s),g=o+e;if(t){const a=t[g];if(p){const t=p.split("/");let[a,f]=t;a=Number(l[o+a]),f=Number(l[o+f]);const u=n(r(a,f),m,c);d&&e===i.field?i[s]=u:i[e]=u}else if(a){const t=n(a,m,c);d?i.field===e&&(i[s]=t):i[e]=t}}d&&a.push(i)}}return a},exports.maxDeltaDay=a,exports.parseDateTime=o,exports.stringifyField=function(e,t,r){return t&&(e=e.filter((e=>e.field===t))),r&&(e=e.filter((e=>e.field&&e.hasOwnProperty(r)))),e.map((e=>{let t=[];return e.computed?t=e.computed.split("/"):t.push(e.field),t=t.map((t=>-1===e.stat?t:`${t} as ${"temp_"+t}`)),t.join()})).join()},exports.stringifyGroupField=function(e,t,r){return t&&(e=e.filter((e=>e.field===t))),r&&(e=e.filter((e=>e.field&&e.hasOwnProperty(r)))),e.map((e=>{const t=e.stat;let r=[];return e.computed?r=e.computed.split("/"):r.push(e.field),r=r.map((e=>{if(-1!==t)return`${t||"sum"}(${"temp_"+e}) as ${e}`})),r.filter(Boolean).join()})).filter(Boolean).join()},exports.stringifyQuery=t;
