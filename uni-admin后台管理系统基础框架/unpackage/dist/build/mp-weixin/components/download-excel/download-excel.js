"use strict";const e=require("./download.js"),t=require("../../common/vendor.js"),r={name:"downloadExcel",props:{type:{type:String,default:"xls"},data:{type:Array,required:!1,default:null},fields:{type:Object,default:()=>null},exportFields:{type:Object,default:()=>null},defaultValue:{type:String,required:!1,default:""},header:{default:null},footer:{default:null},name:{type:String,default:"data.xls"},fetch:{type:Function},meta:{type:Array,default:()=>[]},worksheet:{type:String,default:"Sheet1"},beforeGenerate:{type:Function},beforeFinish:{type:Function},escapeCsv:{type:Boolean,default:!0},stringifyLongNum:{type:Boolean,default:!1}},computed:{idName:()=>"export_"+(new Date).getTime(),downloadFields(){return this.fields?this.fields:this.exportFields?this.exportFields:void 0}},methods:{async generate(){"function"==typeof this.beforeGenerate&&await this.beforeGenerate();let e=this.data;if("function"!=typeof this.fetch&&e||(e=await this.fetch()),!e||!e.length)return;let t=this.getProcessedJson(e,this.downloadFields);return"html"===this.type?this.export(this.jsonToXLS(t),this.name.replace(".xls",".html"),"text/html"):"csv"===this.type?this.export(this.jsonToCSV(t),this.name.replace(".xls",".csv"),"application/csv"):this.export(this.jsonToXLS(t),this.name,"application/vnd.ms-excel")},export:async function(t,r,o){let a=this.base64ToBlob(t,o);"function"==typeof this.beforeFinish&&await this.beforeFinish(),e.download(a,r,o)},jsonToXLS(e){let t="<thead>";const r=Object.keys(e[0]).length;let o=this;const a=this.header||this.$attrs.title;a&&(t+=this.parseExtraData(a,'<tr><th colspan="'+r+'">${data}</th></tr>')),t+="<tr>";for(let s in e[0])t+="<th>"+s+"</th>";return t+="</tr>",t+="</thead>",t+="<tbody>",e.map((function(e,r){t+="<tr>";for(let a in e)t+="<td>"+o.preprocessLongNum(o.valueReformattedForMultilines(e[a]))+"</td>";t+="</tr>"})),t+="</tbody>",null!=this.footer&&(t+="<tfoot>",t+=this.parseExtraData(this.footer,'<tr><td colspan="'+r+'">${data}</td></tr>'),t+="</tfoot>"),'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta name=ProgId content=Excel.Sheet> <meta name=Generator content="Microsoft Excel 11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">\x3c!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>${worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--\x3e<style>br {mso-data-placement: same-cell;}</style></head><body><table>${table}</table></body></html>'.replace("${table}",t).replace("${worksheet}",this.worksheet)},jsonToCSV(e){let t=this,r=[];const o=this.header||this.$attrs.title;o&&r.push(this.parseExtraData(o,"${data}\r\n"));for(let a in e[0])r.push(a),r.push(",");return r.pop(),r.push("\r\n"),e.map((function(e){for(let o in e){let a=e[o]+"";t.escapeCsv&&(a='="'+a+'"',a.match(/[,"\n]/)&&(a='"'+a.replace(/\"/g,'""')+'"')),r.push(a),r.push(",")}r.pop(),r.push("\r\n")})),null!=this.footer&&r.push(this.parseExtraData(this.footer,"${data}\r\n")),r.join("")},getProcessedJson(e,t){let r=this.getKeys(e,t),o=[],a=this;return e.map((function(e,t){let s={};for(let o in r){let t=r[o];s[o]=a.getValue(t,e)}o.push(s)})),o},getKeys(e,t){if(t)return t;let r={};for(let o in e[0])r[o]=o;return r},parseExtraData(e,t){let r="";if(Array.isArray(e))for(let o=0;o<e.length;o++)e[o]&&(r+=t.replace("${data}",e[o]));else r+=t.replace("${data}",e);return r},getValue(e,t){const r="object"!=typeof e?e:e.field;let o="string"!=typeof r?[]:r.split("."),a=this.defaultValue;return a=r?o.length>1?this.getValueFromNestedItem(t,o):this.parseValue(t[r]):t,e.hasOwnProperty("callback")&&(a=this.getValueFromCallback(a,e.callback)),a},valueReformattedForMultilines:e=>"string"==typeof e?e.replace(/\n/gi,"<br/>"):e,preprocessLongNum(e){if(this.stringifyLongNum){if(String(e).startsWith("0x"))return e;if(!isNaN(e)&&""!=e&&(e>99999999999||e<1e-13))return'="'+e+'"'}return e},getValueFromNestedItem(e,t){let r=e;for(let o of t)r&&(r=r[o]);return this.parseValue(r)},getValueFromCallback(e,t){if("function"!=typeof t)return this.defaultValue;const r=t(e);return this.parseValue(r)},parseValue(e){return e||0===e||"boolean"==typeof e?e:this.defaultValue},base64ToBlob(e,t){let r=window.btoa(window.unescape(encodeURIComponent(e))),o=atob(r),a=o.length,s=new Uint8ClampedArray(a);for(;a--;)s[a]=o.charCodeAt(a);return new Blob([s],{type:t})}}};const o=t._export_sfc(r,[["render",function(e,r,o,a,s,n){return{a:t.t(o.name),b:n.idName,c:t.o(((...e)=>n.generate&&n.generate(...e)))}}]]);wx.createComponent(o);
