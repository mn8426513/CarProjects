"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/uni-stat/util.js"),a={data:()=>({query:{dimension:"day",appid:"",version_id:"",start_time:t.getTimeOfSomeDayAgo(0)},platforms:[],dayChartsData:[],monChartsData:[],errorMessage:""}),created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.query)}),300)},watch:{query:{deep:!0,handler(e){this.debounceGet()}}},computed:{chartsData(){return[...this.dayChartsData,...this.monChartsData]},versionQuery(){const{appid:e}=this.query;return t.stringifyQuery({appid:e})}},methods:{getAllData(e){e.appid?(this.errorMessage="",this.getChartData(e),this.getRangeCountData(e,"month")):this.errorMessage="请先选择应用"},getChartData(a,i="day"){a=JSON.parse(JSON.stringify(a));const s=t.getTimeOfSomeDayAgo(0);if(a.start_time>=s){const e=(new Date).getTime();a.start_time=[s,e],a=t.stringifyQuery(a,!0)}else a=t.stringifyQuery(a);e.er.database().collection("uni-stat-result").where(a).field("active_device_count,new_device_count,total_devices,platform_id").groupBy("platform_id").groupField(`sum(active_device_count) as ${i}_active_device_count, sum(new_device_count) as ${i}_new_device_count, max(total_devices) as ${i}_total_devices`).get().then((e=>{const t=e.result.data;this.initChartOption(t,"dayChartsData")}))},getRangeCountData(a,i){a=t.stringifyQuery(a);e.er.database().collection("uni-stat-result").where(a).field(`active_device_count, new_device_count, platform_id, ${i}(add(new Date(0),start_time), "Asia/Shanghai") as ${i},year(add(new Date(0),start_time), "Asia/Shanghai") as year`).groupBy(`year, ${i?i+",":""}platform_id`).groupField(`sum(active_device_count) as ${i}_active_device_count, sum(new_device_count) as ${i}_new_device_count`).orderBy(`year asc, ${i} asc`).get().then((e=>{const t=e.result.data;this.initChartOption(t,"monChartsData","month")}))},initChartOption(t,a,i="day"){e.er.database().collection("uni-stat-app-platforms").get().then((e=>{const s=[{field:`${i}_new_device_count`,title:("day"===i?"日":"月")+"新增设备对比",series:[{data:[]}]},{field:`${i}_active_device_count`,title:("day"===i?"日":"月")+"活跃设备对比",series:[{data:[]}]}];"day"===i&&s.unshift({field:"day_total_devices",title:"总设备数对比",series:[{data:[]}]}),this[a]=s;const r=e.result.data,n={};r.forEach((e=>{n[e._id]=e.name}));for(const i of this[a]){const e=i.series[0].data,a=JSON.parse(JSON.stringify(n));for(const s of t)for(const t in s)if(i.field===t){const i=s.platform_id,r={name:a[i],value:s[t]};e.push(r),delete a[i]}for(const t in a){const i={name:a[t],value:0};e.push(i)}}}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../../components/fix-window/fix-window.js"))();const i=e._export_sfc(a,[["render",function(t,a,i,s,r,n){return{a:e.o((e=>r.query.appid=e)),b:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:r.query.appid}),c:e.o((e=>r.query.version_id=e)),d:e.p({collection:"opendb-app-versions",where:n.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:r.query.version_id}),e:r.query.start_time?1:"",f:e.o((e=>r.query.start_time=e)),g:e.p({type:"date",returnType:"timestamp",clearIcon:!1,modelValue:r.query.start_time}),h:e.f(n.chartsData,((t,a,i)=>({a:e.t(n.chartsData[a].title),b:"73275875-4-"+i,c:e.p({type:"ring",chartData:n.chartsData[a],echartsH5:!0,echartsApp:!0,errorMessage:r.errorMessage}),d:a})))}}]]);wx.createPage(i);
