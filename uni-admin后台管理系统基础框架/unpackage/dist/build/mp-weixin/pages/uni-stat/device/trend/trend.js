"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),i={data:()=>({tableName:"uni-stat-result",fieldsMap:a.fieldsMap,query:{dimension:"day",appid:"",platform_id:"",uni_platform:"",version_id:"",channel_id:"",start_time:[]},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:1,currentDimensionTab:1,tableData:[],panelData:a.fieldsMap.filter((e=>e.hasOwnProperty("value"))),chartData:{},chartTab:"new_user_count",channelData:[],tabIndex:0,errorMessage:"",setOptions:{xAxis:{boundaryGap:!1,axisTick:{show:!1},axisLine:{lineStyle:{color:"#999"}}},tooltip:{trigger:"axis",axisPointer:{type:"cross"}},grid:{left:40,right:50,bottom:50,top:60,containLabel:!0,show:!1}}}),computed:{chartTabs(){const e=[];return a.fieldsMap.forEach((t=>{const{field:a,title:i}=t,n=t.hasOwnProperty("value");a&&i&&n&&e.push({_id:a,name:i})})),e},dimensionTabs(){const e=[{_id:"hour",name:"按时"},{_id:"day",name:"按日"},{_id:"week",name:"按周"},{_id:"month",name:"按月"}];return this.getDays()?e.forEach(((e,t)=>{e._id,e.disabled=!1})):(this.query.dimension="hour",e.forEach(((e,t)=>{"hour"===e._id?e.disabled=!1:e.disabled=!0})),this.currentDimensionTab=0),e},channelQuery(){const e=this.query.platform_id;return t.stringifyQuery({platform_id:e})},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a})}},created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.query)}),300),this.getChannelData()},watch:{query:{deep:!0,handler(e){this.debounceGet()}}},methods:{getDays(){if(!this.query.start_time.length)return!0;const[e,t]=this.query.start_time;return t-e>=864e5},useDatetimePicker(){this.currentDateTab=-1},changeAppid(e){this.getChannelData(e,!1)},changePlatform(e,t,a,i){this.getChannelData(null,e),this.query.version_id=0,this.query.uni_platform=i.code},changeTimeRange(e,a){this.currentDateTab=a;let i,n;i=t.getTimeOfSomeDayAgo(e),n=e?t.getTimeOfSomeDayAgo(0)-1:t.getTimeOfSomeDayAgo(0)+864e5-1,this.query.start_time=[i,n]},changeDimensionTab(e,t){this.currentDimensionTab=t,this.query.dimension=e},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTabelData(this.query)},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTabelData(this.query)},changeChartTab(e,t,a){this.tabIndex=t,this.getChartData(this.query,e,a)},getAllData(e){e.appid?(this.errorMessage="",this.getPanelData(),this.getChartData(e),this.getTabelData(e)):this.errorMessage="请先选择应用"},getChartData(i,n=this.chartTabs[this.tabIndex]._id,s=this.chartTabs[this.tabIndex].name){i=t.stringifyQuery(i,!0,["uni_platform"]);const r=this.query.dimension;e.er.database().collection(this.tableName).where(i).field(`${t.stringifyField(a.fieldsMap,n)}, start_time`).groupBy("start_time").groupField(t.stringifyGroupField(a.fieldsMap,n)).orderBy("start_time","asc").get({getCount:!0}).then((e=>{const{count:i,data:o}=e.result,l={categories:[],series:[{name:s,data:[]}]};let d=a.fieldsMap.filter((e=>e.field===n));d=JSON.parse(JSON.stringify(d)),delete d[0].value,d[0].formatter="";for(const a of o){t.mapfields(d,a,a);const e=t.formatDate(a.start_time,r);let i=a[n];l.series[0].data.push(i),l.categories.push(e)}this.chartData=l})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getTabelData(i){const{pageCurrent:n}=this.options;i=t.stringifyQuery(i,!0,["uni_platform"]),console.log("query: ",i),this.options.pageCurrent=1,this.loading=!0;e.er.database().collection(this.tableName).where(i).field(t.stringifyField(a.fieldsMap)).groupBy("start_time").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("start_time","desc").skip((n-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:i,data:n}=e.result;for(const s of n){let e=s.start_time;if(e){const a=this.query.dimension;s.start_time=t.formatDate(e,a)}t.mapfields(a.fieldsMap,s,s)}this.tableData=[],this.options.total=i,this.tableData=n})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getPanelData(){let i=JSON.parse(JSON.stringify(this.query)),n=t.stringifyQuery(i,!1,["uni_platform"]);e.er.database().collection(this.tableName).where(n).field(`${t.stringifyField(a.fieldsMap)},stat_date`).groupBy("appid").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("stat_date","desc").get().then((e=>{const n=e.result.data[0];n&&(n.total_devices=0),t.getFieldTotal.call(this,i),this.panelData=[],this.panelData=t.mapfields(a.fieldsMap,n)}))},navTo(t){const a=`/pages/uni-stat/overview/overview?id=${t}`;e.index.navigateTo({url:a})},getChannelData(t,a){this.query.channel_id="";const i=e.er.database(),n={};(t=t||this.query.appid)&&(n.appid=t),(a=a||this.query.platform_id)&&(n.platform_id=a);let s=i.collection("uni-stat-app-platforms").field("_id, name").getTemp(),r=i.collection("uni-stat-app-channels").where(n).field("_id, channel_name, create_time, platform_id").getTemp();i.collection(r,s).orderBy("platform_id","asc").get().then((e=>{let t=e.result.data,a=[];if(t.length>0){let e;for(let i in t)e=t[i].channel_name?t[i].channel_name:"默认",t[i].platform_id.length>0&&(e=t[i].platform_id[0].name+"-"+e),a.push({value:t[i]._id,text:e})}this.channelData=a})).catch((e=>{console.error(e)})).finally((()=>{}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-stat-panel")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("uni-stat-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../components/uni-stat-panel/uni-stat-panel.js")+(()=>"../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../../components/uni-stat-table/uni-stat-table.js")+(()=>"../../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../../components/fix-window/fix-window.js"))();const n=e._export_sfc(i,[["render",function(t,a,i,n,s,r){return e.e({a:e.o(r.changeAppid),b:e.o((e=>s.query.appid=e)),c:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:s.query.appid}),d:e.o((e=>s.query.version_id=e)),e:e.p({collection:"opendb-app-versions",where:r.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:s.query.version_id}),f:e.o(r.changeTimeRange),g:e.p({label:"日期选择",current:s.currentDateTab,mode:"date"}),h:s.currentDateTab<0&&s.query.start_time.length?1:"",i:e.o(r.useDatetimePicker),j:e.o((e=>s.query.start_time=e)),k:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:s.query.start_time}),l:e.o(r.changeDimensionTab),m:e.p({label:"维度选择",type:"box",current:s.currentDimensionTab,tabs:r.dimensionTabs}),n:e.o(r.changePlatform),o:e.o((e=>s.query.platform_id=e)),p:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:s.query.platform_id}),q:s.query.platform_id&&-1===s.query.platform_id.indexOf("==")},s.query.platform_id&&-1===s.query.platform_id.indexOf("==")?{r:e.sr("version-select","db457e5e-7"),s:e.o((e=>s.query.channel_id=e)),t:e.p({collection:"uni-stat-app-channels",where:r.channelQuery,field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:s.query.channel_id})}:{},{v:e.p({items:s.panelData}),w:e.o(r.changeChartTab),x:e.o((e=>s.chartTab=e)),y:e.p({type:"box",tabs:r.chartTabs,modelValue:s.chartTab}),z:e.p({type:"area",chartData:s.chartData,echartsH5:!0,echartsApp:!0,errorMessage:s.errorMessage,eopts:s.setOptions}),A:e.p({data:s.tableData,filedsMap:s.fieldsMap,loading:s.loading}),B:e.o(r.changePageCurrent),C:e.o(r.changePageSize),D:e.p({"show-icon":!0,"show-page-size":!0,"page-size":s.options.pageSize,current:s.options.pageCurrent,total:s.options.total})})}]]);wx.createPage(n);
