"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),i={data:()=>({tableName:"uni-stat-result",fieldsMap:a.fieldsMap,query:{dimension:"day",appid:"",platform_id:"",uni_platform:"",version_id:"",channel_id:"",start_time:[]},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:0,currentChartTab:"day",tableData:[],chartData:{},channelData:[],tabName:"日活",errorMessage:""}),computed:{chartTabs(){const e=[{_id:"day",name:"日活"},{_id:"week",name:"周活"},{_id:"month",name:"月活"}];return t.maxDeltaDay(this.query.start_time,7)&&e.forEach(((e,t)=>{"month"===e._id?e.disabled=!0:e.disabled=!1})),e},channelQuery(){const e=this.query.platform_id;return t.stringifyQuery({platform_id:e})},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a})}},created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.query)}),300),this.getChannelData()},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}}},methods:{useDatetimePicker(){this.currentDateTab=-1},changeAppid(e){this.getChannelData(e,!1)},changePlatform(e,t,a,i){this.getChannelData(null,e),this.query.version_id=0,this.query.uni_platform=i.code},changeTimeRange(e,a){this.currentDateTab=a;let i,n;i=t.getTimeOfSomeDayAgo(e),n=e?t.getTimeOfSomeDayAgo(0)-1:t.getTimeOfSomeDayAgo(0)+864e5-1,this.query.start_time=[i,n]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTabelData(this.query)},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTabelData(this.query)},changeChartTab(e,t,a){this.currentChartTab=e,this.tabName=a,this.getChartData(this.query,e,a)},getAllData(e){e.appid?(this.errorMessage="",this.getChartData(e,this.currentChartTab,this.tabName),this.getTabelData(e)):this.errorMessage="请先选择应用"},getChartData(i,n,r="日活",s="active_device_count"){this.chartData={};const o={categories:[],series:[{name:r,data:[]}]};i=t.stringifyQuery(i,!1,["uni_platform"]),console.log("query: ",i);const l=e.er.database();"day"===n?l.collection(this.tableName).where(i).field(`${t.stringifyField(a.fieldsMap,s)}, start_time`).groupBy("start_time").groupField(t.stringifyGroupField(a.fieldsMap,s)).orderBy("start_time","asc").get({getCount:!0}).then((e=>{const{count:a,data:i}=e.result;this.chartData=[];for(const n of i){const e=t.formatDate(n.start_time,"day"),a=n[s];o.series[0].data.push(a),o.categories.push(e)}this.chartData=o})).catch((e=>{console.error(e)})):this.getRangeCountData(i,n).then((e=>{const a=n;"week"===n&&(n="isoWeek");const{count:i,data:r}=e.result;this.chartData=[];for(const l of r){const e=+new Date(l.year,0)+(6048e5*Number(l[n])-1),i=t.formatDate(e,a),r=l[n+"_"+s];r&&(o.series[0].data.push(r),o.categories.push(i))}this.chartData=o}))},getTabelData(i,n="active_device_count"){const{pageCurrent:r}=this.options;let s=t.stringifyQuery(i);this.loading=!0;e.er.database().collection(this.tableName).where(s).field(`${t.stringifyField(a.fieldsMap,n)}, start_time`).groupBy("start_time").groupField(t.stringifyGroupField(a.fieldsMap,n)).orderBy("start_time","desc").skip((r-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:n,data:r}=e.result;let s=r,o=n,l=[],u=[],c=JSON.parse(JSON.stringify(i));c.dimension="week",this.getRangeCountData(t.stringifyQuery(c),"week").then((e=>{const{count:n,data:r}=e.result;l=r;let c=JSON.parse(JSON.stringify(i));c.dimension="month",this.getRangeCountData(t.stringifyQuery(c),"month").then((e=>{const{count:i,data:n}=e.result;u=n;const r=this.mapWithWeekAndMonth(s,l,u);for(const s of r)t.mapfields(a.fieldsMap,s,s);this.tableData=[],this.options.total=o,this.tableData=r})).finally((()=>{this.loading=!1}))}))})).catch((e=>{console.error(e)}))},getRangeCountData(t,a,i="active_device_count"){"week"===a&&(a="isoWeek"),this.options;return e.er.database().collection(this.tableName).where(t).field(`${i}, start_time, ${a}(add(new Date(0),start_time), "Asia/Shanghai") as ${a},year(add(new Date(0),start_time), "Asia/Shanghai") as year`).groupBy(`year, ${a}`).groupField(`sum(${i}) as ${a}_${i}`).orderBy(`year asc, ${a} asc`).get({getCount:!0})},mapWithWeekAndMonth(e,t,a,i="active_device_count"){for(const n of e){const e=new Date(n.start_time),r=e.getUTCFullYear(),s=e.getMonth()+1,o=this.getWeekNumber(e);for(const a of t)a.isoWeek===o&&a.year===r&&(n[`week_${i}`]=a[`isoWeek_${i}`]);for(const t of a)t.month===s&&t.year===r&&(n[`month_${i}`]=t[`month_${i}`])}return e},getWeekNumber(e){(e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()))).setUTCDate(e.getUTCDate()+4-(e.getUTCDay()||7));const t=new Date(Date.UTC(e.getUTCFullYear(),0,1));return Math.ceil(((e-t)/864e5+1)/7)},getChannelData(t,a){this.query.channel_id="";const i=e.er.database(),n={};(t=t||this.query.appid)&&(n.appid=t),(a=a||this.query.platform_id)&&(n.platform_id=a);let r=i.collection("uni-stat-app-platforms").field("_id, name").getTemp(),s=i.collection("uni-stat-app-channels").where(n).field("_id, channel_name, create_time, platform_id").getTemp();i.collection(s,r).orderBy("platform_id","asc").get().then((e=>{let t=e.result.data,a=[];if(t.length>0){let e;for(let i in t)e=t[i].channel_name?t[i].channel_name:"默认",t[i].platform_id.length>0&&(e=t[i].platform_id[0].name+"-"+e),a.push({value:t[i]._id,text:e})}this.channelData=a})).catch((e=>{console.error(e)})).finally((()=>{}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("uni-stat-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../../components/uni-stat-table/uni-stat-table.js")+(()=>"../../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../../components/fix-window/fix-window.js"))();const n=e._export_sfc(i,[["render",function(t,a,i,n,r,s){return e.e({a:e.o(s.changeAppid),b:e.o((e=>r.query.appid=e)),c:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:r.query.appid}),d:e.o((e=>r.query.version_id=e)),e:e.p({collection:"opendb-app-versions",where:s.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:r.query.version_id}),f:e.o(s.changeTimeRange),g:e.p({label:"日期选择",current:r.currentDateTab,mode:"date",yesterday:!1}),h:r.currentDateTab<0&&r.query.start_time.length?1:"",i:e.o(s.useDatetimePicker),j:e.o((e=>r.query.start_time=e)),k:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:r.query.start_time}),l:e.o(s.changePlatform),m:e.o((e=>r.query.platform_id=e)),n:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:r.query.platform_id}),o:r.query.platform_id&&-1===r.query.platform_id.indexOf("==")},r.query.platform_id&&-1===r.query.platform_id.indexOf("==")?{p:e.sr("version-select","03f86fb5-6"),q:e.o((e=>r.query.channel_id=e)),r:e.p({collection:"uni-stat-app-channels",where:s.channelQuery,field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:r.query.channel_id})}:{},{s:e.o(s.changeChartTab),t:e.p({type:"box",tabs:s.chartTabs}),v:e.p({type:"area",chartData:r.chartData,echartsH5:!0,echartsApp:!0,errorMessage:r.errorMessage}),w:e.p({data:r.tableData,filedsMap:r.fieldsMap,loading:r.loading,tooltip:!0}),x:e.o(s.changePageCurrent),y:e.o(s.changePageSize),z:e.p({"show-icon":!0,"show-page-size":!0,"page-size":r.options.pageSize,current:r.options.pageCurrent,total:r.options.total})})}]]);wx.createPage(n);
