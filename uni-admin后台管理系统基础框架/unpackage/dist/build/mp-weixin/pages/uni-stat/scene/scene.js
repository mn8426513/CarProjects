"use strict";const e=require("../../../common/vendor.js"),t=require("../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),i={data:()=>({fieldsMap:a.fieldsMap,query:{dimension:"hour",appid:"",platform_id:"",uni_platform:"",version_id:"",start_time:[]},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:1,tableData:[],panelData:a.fieldsMap.filter((e=>e.hasOwnProperty("value"))),chartData:{},chartTab:"new_device_count",errorMessage:""}),computed:{chartTabs(){const e=[];return a.fieldsMap.forEach((t=>{const{field:a,title:i}=t,n=t.hasOwnProperty("value");a&&i&&n&&e.push({_id:a,name:i})})),e},queryStr(){return t.stringifyQuery(this.query,!0)},dimension(){return t.maxDeltaDay(this.query.start_time,1)?"hour":"day"},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a})}},created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.queryStr)}),300)},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}}},methods:{useDatetimePicker(){this.currentDateTab=-1},changePlatform(e,t,a,i){this.query.version_id=0,this.query.uni_platform=i.code},changeTimeRange(e,a){this.currentDateTab=a;const i=t.getTimeOfSomeDayAgo(e),n=t.getTimeOfSomeDayAgo(0)-1;this.query.start_time=[i,n]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTabelData(this.queryStr)},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTabelData(this.queryStr)},changeChartTab(e,t,a){this.getChartData(this.queryStr,e,a)},getAllData(e){-1!==e.indexOf("appid")?(this.errorMessage="",this.getPanelData(e),this.getChartData(e),this.getTabelData(e)):this.errorMessage="请先选择应用"},getChartData(i,n=this.chartTab){this.options,(i=JSON.parse(JSON.stringify(this.query))).dimension="day";let s=t.stringifyQuery(i,!1,["uni_platform"]);e.er.database().collection("uni-stat-result").where(s).field(`${t.stringifyField(a.fieldsMap,n)},start_time,channel_id`).groupBy("channel_id,start_time").groupField(t.stringifyGroupField(a.fieldsMap,n)).orderBy("start_time","asc").get({getCount:!0}).then((e=>{const{count:i,data:s}=e.result,r={categories:[],series:[{name:"暂无数据",data:[]}]},o=r.categories;if("hour"===this.dimension)for(let t=0;t<24;++t){const e=t<10?"0"+t:t,a=`${e}:00 ~ ${e}:59`;o.push(a)}const l=[];s.forEach((e=>{l.indexOf(e.channel_id)<0&&l.push(e.channel_id)}));let d=[];this.getChannels().then((e=>{d=e.result.data})).finally((()=>{l.forEach(((e,i)=>{const l=d.find((t=>t._id===e)),p=r.series[i]={name:l&&l.channel_name||"未知",data:[]};if("hour"===this.dimension)for(let t=0;t<24;++t)p.data[t]=0;let u=a.fieldsMap.filter((e=>e.field===n));u=JSON.parse(JSON.stringify(u)),delete u[0].value,u[0].formatter="";for(const a of s){t.mapfields(u,a,a);let i=a.start_time;const s=t.formatDate(i,this.dimension);let r=a[n];const l=o.indexOf(s);e===a.channel_id&&(l<0?(o.push(s),p.data.push(r)):p.data[l]=r)}})),this.chartData=r}))})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getChannels:()=>e.er.database().collection("uni-stat-app-channels").get(),getTabelData(i){const{pageCurrent:n}=this.options;this.loading=!0;let s=t.stringifyQuery(this.query,!1,["uni_platform"]);e.er.database().collection("uni-stat-result").where(s).field(`${t.stringifyField(a.fieldsMap)},appid, channel_id`).groupBy("appid, channel_id").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("new_device_count","desc").skip((n-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:i,data:n}=e.result;this.getChannels().then((e=>{const t=e.result.data;for(const a of n)t.forEach((e=>{a.channel_id===e._id&&(a.channel_code=e.channel_code,a.channel_name=e.channel_name)}))})).finally((()=>{for(const e of n)t.mapfields(a.fieldsMap,e,e);this.tableData=[],this.options.total=i,this.tableData=n}))})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getPanelData(){let i=JSON.parse(JSON.stringify(this.query));i.dimension="day";let n=t.stringifyQuery(i,!1,["uni_platform"]);e.er.database().collection("uni-stat-result").where(n).field(t.stringifyField(a.fieldsMap)).groupBy("appid").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("start_time","desc").get().then((e=>{const n=e.result.data[0];n&&(n.total_devices=0),t.getFieldTotal.call(this,i),this.panelData=[],this.panelData=t.mapfields(a.fieldsMap,n)}))},navTo(t){const a=`/pages/uni-stat/overview/overview?id=${t}`;e.index.navigateTo({url:a})}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-stat-panel")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("uni-stat-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../components/uni-stat-panel/uni-stat-panel.js")+(()=>"../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../components/uni-stat-table/uni-stat-table.js")+(()=>"../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../components/fix-window/fix-window.js"))();const n=e._export_sfc(i,[["render",function(t,a,i,n,s,r){return{a:e.o((e=>s.query.appid=e)),b:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:s.query.appid}),c:e.o((e=>s.query.version_id=e)),d:e.p({collection:"opendb-app-versions",where:r.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:s.query.version_id}),e:e.o(r.changeTimeRange),f:e.p({label:"日期选择",current:s.currentDateTab,mode:"date"}),g:s.currentDateTab<0&&s.query.start_time.length?1:"",h:e.o(r.useDatetimePicker),i:e.o((e=>s.query.start_time=e)),j:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:s.query.start_time}),k:e.o(r.changePlatform),l:e.o((e=>s.query.platform_id=e)),m:e.p({label:"平台选择",type:"boldLine",mode:"platform-scene",all:!1,modelValue:s.query.platform_id}),n:e.p({items:s.panelData}),o:e.o(r.changeChartTab),p:e.o((e=>s.chartTab=e)),q:e.p({type:"box",tabs:r.chartTabs,modelValue:s.chartTab}),r:e.p({type:"area",chartData:s.chartData,echartsH5:!0,echartsApp:!0,tooltipFormat:"tooltipCustom",errorMessage:s.errorMessage}),s:e.p({data:s.tableData,filedsMap:s.fieldsMap.slice(0,s.fieldsMap.length-1),loading:s.loading}),t:e.o(r.changePageCurrent),v:e.o(r.changePageSize),w:e.p({"show-icon":!0,"show-page-size":!0,"page-size":s.options.pageSize,current:s.options.pageCurrent,total:s.options.total})}}]]);wx.createPage(n);
