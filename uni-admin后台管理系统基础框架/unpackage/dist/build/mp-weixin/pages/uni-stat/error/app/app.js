"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),r=require("../../../../js_sdk/validator/uni-stat-app-crash-logs.js"),i=require("../../../../uni-stat-breadcrumb.js"),o=require("../../../../uni-data-select.js"),n=require("../../../../uni-stat-tabs.js"),s=require("../../../../uni-datetime-picker.js"),d=require("../../../../uni-stat-panel.js"),p=require("../../../../qiun-data-charts.js"),l=require("../../../../uni-th.js"),c=require("../../../../uni-tr.js"),u=require("../../../../uni-td.js"),_=require("../../../../uni-dateformat.js"),m=require("../../../../uni-table.js"),h=require("../../../../uni-pagination.js"),f=require("../../../../unicloud-db.js"),g=require("../../../../fix-window.js"),v=[{title:"崩溃总数",field:"count",value:0,formatter:",",tooltip:"指原生应用在某个时间段内出现崩溃的总数"},{title:"崩溃率",field:"count/app_launch_count",computed:"count/app_launch_count",formatter:"%",value:0,tooltip:"时间范围内的总崩溃数/原生应用启动次数，如果小于0.01%，默认显示为0"}],y=e.er.database(),b=[],C={ascending:"asc",descending:"desc"},D={data(){return{fieldsMap:a.fieldsMap,query:{type:"crash",dimension:"day",appid:"",platform_id:"",uni_platform:"",version_id:"",start_time:[]},loading:!1,popupLoading:!1,currentDateTab:0,tableData:[],popupTableData:[],panelData:JSON.parse(JSON.stringify(v)),chartData:{},chartTab:"errorCount",chartTabs:[{_id:"errorCount",name:"崩溃次数"},{_id:"errorRate",name:"崩溃率"}],collectionList:"uni-stat-app-crash-logs",schemaQuery:"",where:this.tableData,orderby:"create_time desc",orderByFieldName:"",selectedIndexs:[],options:{pageCurrent:1,total:0,pageSizeIndex:0,pageSizeRange:[10,20,50,100],pageSize:20,pageCurrent:1,filterData:{},...r.enumConverter},errorMessage:"",exportExcel:{filename:"uni-stat-app-crash-logs.xls",type:"xls",fields:{appid:"appid",version:"version",platform:"platform",channel:"channel",sdk_version:"sdk_version",device_id:"device_id",device_net:"device_net",device_os:"device_os",device_os_version:"device_os_version",device_vendor:"device_vendor",device_model:"device_model",device_is_root:"device_is_root",device_os_name:"device_os_name",device_batt_level:"device_batt_level",device_batt_temp:"device_batt_temp",device_memory_use_size:"device_memory_use_size",device_memory_total_size:"device_memory_total_size",device_disk_use_size:"device_disk_use_size",device_disk_total_size:"device_disk_total_size",device_abis:"device_abis",app_count:"app_count",app_use_memory_size:"app_use_memory_size",app_webview_count:"app_webview_count",app_use_duration:"app_use_duration",app_run_fore:"app_run_fore",package_name:"package_name",package_version:"package_version",page_url:"page_url",error_msg:"error_msg",create_time:"create_time"}},exportExcelData:[]}},computed:{queryStr(){return t.stringifyQuery(this.query)},tableQuery(){const{appid:e,platform_id:a,version_id:r,start_time:i}=this.query,o=this.getPlatform(a),n=this.getVersion(r);return t.stringifyQuery({appid:e,create_time:i,platform:o,version:n})},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a,type:"native_app"})}},created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.queryStr),this.where=this.tableQuery,this.$nextTick((()=>{this.$refs.udb&&this.$refs.udb.loadData()}),200)}),300),this.debounceGet()},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}},chartTab(e){this.getChartData(this.queryStr)}},onLoad(){this._filter={}},methods:{onqueryload(e){this.exportExcelData=e,this.tableData=e},getWhere(){const e=this.schemaQuery.trim();if(!e)return"";const t=new RegExp(e,"i");return b.map((e=>t+".test("+e+")")).join(" || ")},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+C[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,t){this._filter[t]={type:e.filterType,value:e.filter};let a=r.filterToWhere(this._filter,y.command);Object.keys(a).length?this.where=a:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},useDatetimePicker(){this.currentDateTab=-1},changePlatform(e,t,a,r){this.query.version_id=0,this.query.uni_platform=r.code},changeTimeRange(e,a){this.currentDateTab=a;const r=t.getTimeOfSomeDayAgo(e),i=t.getTimeOfSomeDayAgo(0)-1;this.query.start_time=[r,i]},getPlatform(t){const a=e.index.getStorageSync("uni-admin-statTabsData")["platform-channel"],r=Array.isArray(a)&&a.find((e=>e._id===t));return r&&r.code||""},getVersion(e){let t=[];this.$refs["app-versions"]&&"function"==typeof this.$refs["app-versions"].getLoadData&&(t=this.$refs["app-versions"].getLoadData());const a=Array.isArray(t)&&t.find((t=>t._id===e));return a&&a.text||""},getAllData(e){-1!==e.indexOf("appid")?(this.errorMessage="",this.getPanelData(e),this.getChartData(e)):this.errorMessage="请先选择应用"},getPanelData(a){let r=t.stringifyQuery(this.query,!1,["uni_platform"]);e.er.database().collection("uni-stat-error-result").where(r).field("count as temp_count, app_launch_count as temp_app_launch_count, appid").groupBy("appid").groupField("sum(temp_count) as count, sum(temp_app_launch_count) as app_launch_count").get({getCount:!0}).then((e=>{e.result;const a=e.result.data[0]||{count:0,app_launch_count:0};let r=Object.assign({},this.query);delete r.type,this.getTotalLaunch(t.stringifyQuery(r,!1,["uni_platform"])).then((e=>{const r=e.result.data[0];if(a){let e=r&&r.total_app_launch_count;a.app_launch_count=e,this.panelData=t.mapfields(v,a)}}))}))},getTotalLaunch:t=>e.er.database().collection("uni-stat-result").where(t).groupBy("appid").groupField("sum(app_launch_count) as total_app_launch_count").get(),getChartData(a,r="day_count"){let i=t.stringifyQuery(this.query,!1,["uni_platform"]);this.chartData={},this.options;const o=e.er.database(),[n,s]=this.query.start_time,d=t.getAllDateCN(new Date(n),new Date(s));o.collection("uni-stat-error-result").where(i).field("count as temp_count, app_launch_count as temp_app_launch_count, start_time").groupBy("start_time").groupField("sum(temp_count) as count, sum(temp_app_launch_count) as app_launch_count").orderBy("start_time","asc").get({getCount:!0}).then((e=>{const{count:a,data:r}=e.result;let i=[];d.forEach((e=>{let t=r.find((t=>t.start_time===e));t?i.push(t):i.push({app_launch_count:0,count:0,start_time:e})}));const o={categories:[],series:[{name:"暂无数据",data:[]}]};if("errorCount"===this.chartTab){const e=o.series[0]={name:"崩溃次数",data:[]},a=o.categories;for(const r of i){let i=r.start_time;const o=t.formatDate(i,"day"),n=r.count;a.push(o),e.data.push(n)}this.chartData=o}else{const e=o.series[0]={name:"崩溃率(%)",data:[],lineStyle:{color:"#EE6666",width:1},itemStyle:{borderWidth:1,borderColor:"#EE6666",color:"#EE6666"},areaStyle:{color:{colorStops:[{offset:0,color:"#EE6666"},{offset:1,color:"#FFFFFF"}]}}},a=o.categories;for(const r of i){const{count:i,app_launch_count:o}=r;let n=r.start_time;const s=t.formatDate(n,"day");a.push(s);let d=i/o;d=d?d.toFixed(2):0,e.data.push(d)}this.chartData=o}})).finally((()=>{}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-stat-panel")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("unicloud-db")+e.resolveComponent("fix-window"))()}Math||(i.Component+o.Component+n.Component+s.Component+d.Component+p.Component+l.Component+c.Component+u.Component+_.Component+m.Component+h.Component+f.Component+g.Component)();const q=e._export_sfc(D,[["render",function(t,a,r,i,o,n){return{a:e.o((e=>o.query.appid=e)),b:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:o.query.appid}),c:e.sr("app-versions","553f2d9d-2"),d:e.o((e=>o.query.version_id=e)),e:e.p({collection:"opendb-app-versions",where:n.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:o.query.version_id}),f:e.o(n.changePlatform),g:e.o((e=>o.query.platform_id=e)),h:e.p({label:"平台选择",type:"boldLine",all:!1,mode:"platform-channel",modelValue:o.query.platform_id}),i:e.o(n.changeTimeRange),j:e.p({label:"日期选择",current:o.currentDateTab,yesterday:!1,mode:"date"}),k:o.currentDateTab<0&&o.query.start_time.length?1:"",l:e.o(n.useDatetimePicker),m:e.o((e=>o.query.start_time=e)),n:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:o.query.start_time}),o:e.p({items:o.panelData}),p:e.o((e=>o.chartTab=e)),q:e.p({type:"box",tabs:o.chartTabs,modelValue:o.chartTab}),r:e.p({type:"area",chartData:o.chartData,eopts:{notMerge:!0},echartsH5:!0,echartsApp:!0,tooltipFormat:"tooltipCustom",errorMessage:o.errorMessage}),s:e.w((({data:a,pagination:r,loading:i,error:n,options:s},d,p)=>({a:e.f(o.fieldsMap,((t,a,r)=>e.e({a:t.title},t.title?{b:e.t(t.title),c:a,d:15*t.title.length+80+"px",e:"553f2d9d-12-"+p+"-"+r+",553f2d9d-11-"+p,f:e.p({align:"center"})}:{},{g:a}))),b:"553f2d9d-11-"+p+",553f2d9d-10-"+p,c:e.f(o.tableData,((t,a,r)=>({a:e.f(o.fieldsMap,((a,i,o)=>e.e({a:"error_msg"===a.field},"error_msg"===a.field?{b:e.t(t.error_msg?t.error_msg.substring(0,100)+"...":"-"),c:a.field,d:"553f2d9d-14-"+p+"-"+r+"-"+o+",553f2d9d-13-"+p+"-"+r,e:e.p({align:"left"})}:"create_time"===a.field?{g:"553f2d9d-16-"+p+"-"+r+"-"+o+",553f2d9d-15-"+p+"-"+r+"-"+o,h:e.p({threshold:[0,0],date:t.create_time}),i:a.field,j:"553f2d9d-15-"+p+"-"+r+"-"+o+",553f2d9d-13-"+p+"-"+r,k:e.p({align:"center"})}:{l:e.t(void 0!==t[a.field]?t[a.field]:"-"),m:a.field,n:"553f2d9d-17-"+p+"-"+r+"-"+o+",553f2d9d-13-"+p+"-"+r,o:e.p({align:"center"})},{f:"create_time"===a.field,p:i}))),b:a,c:"553f2d9d-13-"+p+"-"+r+",553f2d9d-10-"+p}))),d:e.sr("table","553f2d9d-10-"+p+",553f2d9d-9"),e:"553f2d9d-10-"+p+",553f2d9d-9",f:e.p({loading:i,border:!0,stripe:!0,emptyText:o.errorMessage||t.$t("common.empty")}),g:"553f2d9d-18-"+p+",553f2d9d-9",h:e.o((e=>r.current=e)),i:e.p({"show-icon":!0,"page-size":r.size,total:r.count,modelValue:r.current}),j:p,k:d})),{name:"d",path:"s",vueId:"553f2d9d-9"}),t:e.o(n.onPageChanged),v:e.sr("udb","553f2d9d-9"),w:e.o(n.onqueryload),x:e.p({collection:o.collectionList,field:"appid,version,platform,channel,sdk_version,device_id,device_net,device_os,device_os_version,device_vendor,device_model,device_is_root,device_os_name,device_batt_level,device_batt_temp,device_memory_use_size,device_memory_total_size,device_disk_use_size,device_disk_total_size,device_abis,app_count,app_use_memory_size,app_webview_count,app_use_duration,app_run_fore,package_name,package_version,page_url,error_msg,create_time",where:o.where,"page-data":"replace",orderby:o.orderby,getcount:!0,"page-size":o.options.pageSize,"page-current":o.options.pageCurrent,loadtime:"manual",options:o.options})}}]]);wx.createPage(q);
