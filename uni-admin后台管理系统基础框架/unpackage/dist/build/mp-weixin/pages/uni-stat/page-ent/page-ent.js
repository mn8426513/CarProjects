"use strict";const e=require("../../../common/vendor.js"),t=require("../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),i={data:()=>({fieldsMap:a.fieldsMap,query:{dimension:"day",appid:"",platform_id:"",uni_platform:"",version_id:"",channel_id:"",start_time:[]},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:1,tableData:[],panelData:a.fieldsMap.filter((e=>e.hasOwnProperty("value"))),channelData:[],errorMessage:""}),computed:{channelQuery(){const e=this.query.platform_id;return t.stringifyQuery({platform_id:e})},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a})}},created(){this.debounceGet=t.debounce((()=>this.getAllData())),this.getChannelData()},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}}},methods:{useDatetimePicker(){this.currentDateTab=-1},changeAppid(e){this.getChannelData(e,!1)},changePlatform(e,t,a,i){this.getChannelData(null,e),this.query.version_id=0,this.query.uni_platform=i.code},changeTimeRange(e,a){this.currentDateTab=a;const i=t.getTimeOfSomeDayAgo(e),n=t.getTimeOfSomeDayAgo(0)-1;this.query.start_time=[i,n]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTableData()},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTableData()},getAllData(){this.getPanelData(),this.getTableData()},getTableData(i){if(!this.query.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="",i=t.stringifyQuery(this.query,null,["uni_platform"]);const{pageCurrent:n}=this.options;this.loading=!0;const r=e.er.database(),o=t.stringifyQuery({appid:this.query.appid}),s=r.collection("uni-stat-pages").where(o).getTemp(),l=r.collection("uni-stat-page-result").where(i+" && entry_count > 0").getTemp();r.collection(l,s).field(`${t.stringifyField(a.fieldsMap)}, stat_date, page_id`).groupBy("page_id").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("entry_count","desc").skip((n-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:i,data:n}=e.result;this.options.total=i,this.tableData=[];for(const r of n){const e=r.page_id;if(Array.isArray(e)){delete r.page_id;const t=e[0];if(t&&Object.keys(t).length)for(const e in t)"_id"!==e&&(r[e]=t[e])}t.mapfields(a.fieldsMap,r,r),this.tableData.push(r)}})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getPanelData(i=t.stringifyQuery(this.query,null,["uni_platform"])){if(!this.query.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="";e.er.database().collection("uni-stat-page-result").where(i).field(t.stringifyField(a.fieldsMap)).groupBy("appid").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("start_time","desc ").get().then((e=>{const i=e.result.data[0];this.panelData=[],this.panelData=t.mapfields(a.fieldsMap,i)}))},navTo(t){const a=`/pages/uni-stat/overview/overview?id=${t}`;e.index.navigateTo({url:a})},getChannelData(t,a){this.query.channel_id="";const i=e.er.database(),n={};(t=t||this.query.appid)&&(n.appid=t),(a=a||this.query.platform_id)&&(n.platform_id=a);let r=i.collection("uni-stat-app-platforms").field("_id, name").getTemp(),o=i.collection("uni-stat-app-channels").where(n).field("_id, channel_name, create_time, platform_id").getTemp();i.collection(o,r).orderBy("platform_id","asc").get().then((e=>{let t=e.result.data,a=[];if(t.length>0){let e;for(let i in t)e=t[i].channel_name?t[i].channel_name:"默认",t[i].platform_id.length>0&&(e=t[i].platform_id[0].name+"-"+e),a.push({value:t[i]._id,text:e})}this.channelData=a})).catch((e=>{console.error(e)})).finally((()=>{}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-stat-panel")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../components/uni-stat-panel/uni-stat-panel.js")+(()=>"../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../components/fix-window/fix-window.js"))();const n=e._export_sfc(i,[["render",function(t,a,i,n,r,o){return e.e({a:e.o((e=>r.query.appid=e)),b:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:r.query.appid}),c:e.o((e=>r.query.version_id=e)),d:e.p({collection:"opendb-app-versions",where:o.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:r.query.version_id}),e:e.o(o.changeTimeRange),f:e.p({label:"日期选择",current:r.currentDateTab,mode:"date"}),g:r.currentDateTab<0&&r.query.start_time.length?1:"",h:e.o(o.useDatetimePicker),i:e.o((e=>r.query.start_time=e)),j:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:r.query.start_time}),k:e.o(o.changePlatform),l:e.o((e=>r.query.platform_id=e)),m:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:r.query.platform_id}),n:r.query.platform_id&&-1===r.query.platform_id.indexOf("==")},r.query.platform_id&&-1===r.query.platform_id.indexOf("==")?{o:e.sr("version-select","2d088340-6"),p:e.o((e=>r.query.channel_id=e)),q:e.p({collection:"uni-stat-app-channels",where:o.channelQuery,field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:r.query.channel_id})}:{},{r:e.p({items:r.panelData}),s:e.f(r.fieldsMap,((t,a,i)=>e.e({a:t.title},t.title?{b:e.t(t.title),c:a,d:"2d088340-10-"+i+",2d088340-9",e:e.p({align:"center"})}:{},{f:a}))),t:e.f(r.tableData,((t,a,i)=>({a:e.f(r.fieldsMap,((a,n,r)=>({a:e.t(void 0!==t[a.field]?t[a.field]:"-"),b:n,c:"2d088340-12-"+i+"-"+r+",2d088340-11-"+i,d:e.p({align:0===n?"left":"center"})}))),b:a,c:"2d088340-11-"+i+",2d088340-8"}))),v:e.p({loading:r.loading,border:!0,stripe:!0,emptyText:r.errorMessage||t.$t("common.empty")}),w:e.o(o.changePageCurrent),x:e.o(o.changePageSize),y:e.p({"show-icon":!0,"show-page-size":!0,"page-size":r.options.pageSize,current:r.options.pageCurrent,total:r.options.total})})}]]);wx.createPage(n);
