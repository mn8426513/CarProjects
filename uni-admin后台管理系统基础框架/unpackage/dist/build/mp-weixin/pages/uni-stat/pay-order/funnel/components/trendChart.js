"use strict";const e=require("../../../../../common/vendor.js"),t=require("../../../../../js_sdk/uni-stat/util.js"),a=require("../../../../../js_sdk/uni-stat/timeUtil.js"),i=require("../fieldsMap.js"),s={props:{query:{type:[Object],default:function(){return{}}}},data:()=>({tableName:"uni-stat-pay-result",chartData:{},errorMessage:"",opts:{color:["#1890FF","#91CB74","#FAC858","#EE6666","#73C0DE","#3CA272","#FC8452","#9A60B4","#ea7ccc"],padding:[15,15,0,15],legend:{},enableScroll:!0,xAxis:{disableGrid:!0,itemCount:24,fontSize:12},yAxis:{gridType:"dash",dashLength:2,data:[{tofix:2,unit:"%"}]},extra:{area:{type:"straight",opacity:.2,addLine:!0,width:2,gradient:!1}}},dateTabs:{time:[],timeStr:"",index:0,list:[{_id:7,name:"最近七天",dimension:"day"},{_id:30,name:"最近30天",dimension:"day"},{_id:90,name:"最近90天",dimension:"day"},{_id:372,name:"月维度",dimension:"month"},{_id:1116,name:"季维度",dimension:"quarter"},{_id:4392,name:"年维度",dimension:"year"}]},statTabs:{index:0,list:[{_id:1,name:"支付转化率"}]},queryMode:0}),created(){this.getCloudDataDebounce=t.debounce((()=>{this.getCloudData()}),300),this.getCloudDataDebounce()},methods:{getCloudData(a={}){let s=this.query;if(!s.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="";let r=this.getWhere(),n={...s,...r};n=t.stringifyQuery(n,!0,["uni_platform"]);e.er.database().collection(this.tableName).where(n).field(`${t.stringifyField(i.fieldsMap)}, start_time`).groupBy("start_time, dimension").groupField(t.stringifyGroupField(i.fieldsMap)).orderBy("start_time","asc").limit(100).get({getCount:!0}).then((e=>{let{count:a,data:s}=e.result;s=t.fillTrendChartData(s,r,i.fieldsMap),s.map(((e,t)=>{e.value=Number((e.pay_user_count/e.activity_user_count*100).toFixed(2)),isNaN(e.value)&&(e.value=0)})),this.setChartData(s,r.dimension)})).catch((e=>{console.error(e)})).finally((()=>{}))},setChartData(e,t){let a={categories:[],series:[{name:"支付转化率",data:[]}]};for(const i of e){const e=this.formatDate(i.start_time,t);a.categories.push(e);let s=Number(i.value);a.series[0].data.push(s)}this.chartData=a},formatDate(e,a){let i=new Date(e),s=i.getFullYear(),r=i.getMonth()+1;i.getDate();let n=i.getHours(),d=Math.floor((i.getMonth()+3)/3);return r<10&&(r="0"+r),"hour"===a?`${n}时`:"month"===a?`${s}-${r}`:"quarter"===a?`${s}/Q${d}`:"year"===a?`${s}`:t.parseDateTime(i)},datePickerChange(e){this.dateTabs.time=e,this.queryMode=1,this.getCloudData()},dateTabsChange(e,t){this.dateTabs.index=t,this.queryMode=0,this.getCloudData()},statTabsChange(e,t,a){this.statTabs.index=t,this.getCloudData({field:e,name:a})},getWhere(){let e=[],i=this.dateTabs.list[this.dateTabs.index]||{};if("number"==typeof i._id&&0===this.queryMode){let s=t.getTimeOfSomeDayAgo(i._id),r=a.timeUtil.getOffsetStartAndEnd("day",0).endTime;1==i._id&&(r=a.timeUtil.getOffsetStartAndEnd("day",0,s).endTime),e=[s,r]}else this.dateTabs.time&&(e=this.dateTabs.time);let s=i.dimension||"day";return this.dateTabs.timeStr=`${a.timeUtil.timeFormat(e[0])} ~ ${a.timeUtil.timeFormat(e[1])}`,this.dateTabs.time=e,{dimension:s,start_time:e}}},watch:{query:{deep:!0,handler(e){this.getCloudDataDebounce()}}},computed:{}};if(!Array){(e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("qiun-data-charts"))()}Math||((()=>"../../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js"))();const r=e._export_sfc(s,[["render",function(t,a,i,s,r,n){return e.e({a:e.o(n.dateTabsChange),b:e.p({type:"box",current:r.dateTabs.index,tabs:r.dateTabs.list}),c:e.o(n.datePickerChange),d:e.o((e=>r.dateTabs.time=e)),e:e.p({type:"datetimerange",end:Date.now(),"return-type":"timestamp","clear-icon":!1,modelValue:r.dateTabs.time}),f:r.dateTabs.timeStr},r.dateTabs.timeStr?{g:e.t(r.dateTabs.timeStr)}:{},{h:e.o(n.statTabsChange),i:e.p({type:"box",current:r.statTabs.index,tabs:r.statTabs.list}),j:e.p({type:"area",chartData:r.chartData,opts:r.opts,errorMessage:r.errorMessage})})}]]);wx.createComponent(r);
