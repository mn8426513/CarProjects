"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/validator/uni-pay-orders.js"),d=require("../../../../js_sdk/uni-stat/util.js"),a=e.er.importObject("uni-pay-co"),r=e.er.database(),n={ascending:"asc",descending:"desc"},o={data:()=>({collectionList:"uni-pay-orders",query:{appid:"",platform_id:"",uni_platform:"",version:"",pay_date:[]},where:"",orderby:"create_date desc",orderByFieldName:"",selectedIndexs:[],filterDefaultValueUserId:"",refundFormData:{out_trade_no:"",max_refund_fee:"",refund_fee:"",refund_desc:""},refundFormRules:{refund_fee:{rules:[{required:!0,errorMessage:"退款金额必须>0"},{minimum:.01,maximum:0,errorMessage:"最大可退 {maximum} 元"}]},refund_desc:{rules:[{required:!0,errorMessage:"请输入退款原因"}]}},options:{pageSize:20,pageCurrent:1,filterData:{provider_localdata:[{text:"微信支付",value:"wxpay"},{text:"支付宝",value:"alipay"},{text:"苹果应用内支付",value:"appleiap"}],status_localdata:[{text:"已关闭",value:-1},{text:"未支付",value:0},{text:"已支付",value:1},{text:"已部分退款",value:2},{text:"已全额退款",value:3}]},...t.enumConverter},imageStyles:{width:64,height:64},exportExcel:{filename:"uni-pay-orders.xls",type:"xls",fields:{"用户ID":"user_id","用户昵称":"nickname","支付供应商":"provider","支付方式":"provider_pay_type","应用平台":"uni_platform","订单状态":"status","支付失败原因":"err_msg","订单类型":"type","业务系统订单号":"order_no","支付插件订单号":"out_trade_no","交易单号":"transaction_id","支付描述":"description","订单支付金额":"total_fee","订单退款金额":"refund_fee","当前退款笔数":"refund_count","退款详情":"refund_list","回调状态":"user_order_success","创建时间":"create_date","支付时间":"pay_date","异步通知时间":"notify_date","取消时间":"cancel_date","开放平台appid":"provider_appid","DCloud AppId":"appid","设备ID":"device_id","客户端IP":"client_ip",openid:"openid"}},exportExcelData:[]}),onLoad(e){this._filter={},e.user_id&&(this.filterDefaultValueUserId=e.user_id,this.filterChange({filterType:"search",filter:e.user_id},"user_id"))},onReady(){this.$refs.udb.loadData()},methods:{onqueryload(e){this.exportExcelData=e},getWhere(){let e="",{pay_date:t,appid:d,version:a,uni_platform:r}=this.query;return t&&2==t.length&&(e+=` && pay_date>=${t[0]} && pay_date<=${t[1]}`),d&&(e+=` && appid=='${d}'`),a&&(e+=` && stat_data.app_version=='${a}'`),r&&(e+=` && stat_data.platform=='${r}'`),e=e.substring(3).trim(),e},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(t,d){e.index.navigateTo({url:t,events:{refreshData:()=>{this.loadData(d)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},refundPopup(e,t){if(e){let{total_fee:e=0,refund_fee:d=0,out_trade_no:a}=t,r=Number(((e-d)/100).toFixed(2));this.refundFormData.max_refund_fee=r,this.refundFormData.refund_fee=r,this.refundFormData.out_trade_no=a,this.refundFormRules.refund_fee.rules[1].maximum=r,this.$refs.popup.open()}else this.refundFormData.max_refund_fee="",this.refundFormData.refund_fee="",this.refundFormData.out_trade_no="",this.refundFormRules.refund_fee.rules[1].maximum=0,this.$refs.popup.close()},async confirmRefund(t){let{total_fee:d=0,refund_fee:r=0,out_trade_no:n,refund_desc:o}=t;t.refund_fee=Number(t.refund_fee.toFixed(2)),this.$refs.refundForm.validate().then((async d=>{let i=Number(r);if(isNaN(i)||i<=0)return void e.index.showToast({title:"请输入正确的退款金额",icon:"none",success:()=>{setTimeout((()=>{this.confirmRefund(t)}),500)}});let s={out_trade_no:n,refund_fee:parseInt(100*i),refund_desc:o};(await a.refund(s)).errCode||(this.refundPopup(!1),this.loadData(!1))})).catch((e=>{}))},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+n[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,d,a){a&&e.filter&&"object"==typeof e.filter&&("number"==typeof e.filter[0]&&(e.filter[0]=e.filter[0]/a),"number"==typeof e.filter[1]&&(e.filter[1]=e.filter[1]/a)),this._filter[d]={type:e.filterType,value:e.filter};let n=t.filterToWhere(this._filter,r.command);Object.keys(n).length?this.where=n:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},platformChange(e,t,d,a){this.query.version=0,this.query.uni_platform=a.code},nameFormat:e=>e.user_id?e.nickname?`${e.user_id}（${e.nickname}）`:e.user_id:"匿名用户",pageToUser(t){let{user_id:d}=t;e.index.navigateTo({url:`/pages/system/user/list?id=${d}`})}},watch:{query:{deep:!0,handler(e){this.search()}}},computed:{versionQuery(){const{appid:e,uni_platform:t}=this.query;return d.stringifyQuery({appid:e,uni_platform:t})}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("download-excel")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("unicloud-db")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../components/download-excel/download-excel.js")+(()=>"../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js")+(()=>"../../../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const i=e._export_sfc(o,[["render",function(t,d,a,r,n,o){return{a:e.o(((...e)=>o.search&&o.search(...e))),b:e.p({fields:n.exportExcel.fields,data:n.exportExcelData,type:n.exportExcel.type,name:n.exportExcel.filename}),c:e.o(o.platformChange),d:e.o((e=>n.query.platform=e)),e:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:n.query.platform}),f:e.w((({data:t,pagination:d,loading:a,error:r,options:n},i,s)=>({a:"574dd5d2-6-"+s+",574dd5d2-5-"+s,b:e.sr("user_id","574dd5d2-7-"+s+",574dd5d2-5-"+s),c:"574dd5d2-7-"+s+",574dd5d2-5-"+s,d:"574dd5d2-8-"+s+",574dd5d2-5-"+s,e:e.p({align:"center","filter-type":"select","filter-data":n.filterData.provider_localdata}),f:"574dd5d2-9-"+s+",574dd5d2-5-"+s,g:"574dd5d2-10-"+s+",574dd5d2-5-"+s,h:"574dd5d2-11-"+s+",574dd5d2-5-"+s,i:e.p({align:"center","filter-type":"select","filter-data":n.filterData.status_localdata}),j:"574dd5d2-12-"+s+",574dd5d2-5-"+s,k:"574dd5d2-13-"+s+",574dd5d2-5-"+s,l:"574dd5d2-14-"+s+",574dd5d2-5-"+s,m:"574dd5d2-15-"+s+",574dd5d2-5-"+s,n:"574dd5d2-16-"+s+",574dd5d2-5-"+s,o:"574dd5d2-17-"+s+",574dd5d2-5-"+s,p:"574dd5d2-18-"+s+",574dd5d2-5-"+s,q:"574dd5d2-19-"+s+",574dd5d2-5-"+s,r:"574dd5d2-20-"+s+",574dd5d2-5-"+s,s:"574dd5d2-21-"+s+",574dd5d2-5-"+s,t:"574dd5d2-22-"+s+",574dd5d2-5-"+s,v:"574dd5d2-23-"+s+",574dd5d2-5-"+s,w:"574dd5d2-24-"+s+",574dd5d2-5-"+s,x:"574dd5d2-25-"+s+",574dd5d2-5-"+s,y:"574dd5d2-26-"+s+",574dd5d2-5-"+s,z:"574dd5d2-27-"+s+",574dd5d2-5-"+s,A:"574dd5d2-28-"+s+",574dd5d2-5-"+s,B:"574dd5d2-5-"+s+",574dd5d2-4-"+s,C:e.f(t,((t,a,r)=>e.e({a:e.t(parseInt(a+1+(d.current-1)*d.size)),b:"574dd5d2-30-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,c:e.t(o.nameFormat(t)),d:e.o((e=>o.pageToUser(t)),a),e:"574dd5d2-31-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,f:e.t(n.provider_valuetotext[t.provider]),g:"574dd5d2-32-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,h:e.t(t.provider_pay_type),i:"574dd5d2-33-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,j:e.t(t.uni_platform),k:"574dd5d2-34-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,l:e.t(n.status_valuetotext[t.status]),m:"574dd5d2-35-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,n:e.t(t.type),o:"574dd5d2-36-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,p:e.t(t.order_no),q:"574dd5d2-37-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,r:e.t(t.out_trade_no),s:"574dd5d2-38-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,t:e.t(t.transaction_id),v:"574dd5d2-39-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,w:e.t(t.description),x:"574dd5d2-40-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,y:e.t((.01*t.total_fee).toFixed(2)),z:"574dd5d2-41-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,A:e.t((.01*t.refund_fee).toFixed(2)),B:"574dd5d2-42-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,C:e.t(t.refund_count),D:"574dd5d2-43-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,E:!0===t.user_order_success},(!0===t.user_order_success||[-1,0].indexOf(t.status),{}),{F:[-1,0].indexOf(t.status)>-1,G:"574dd5d2-44-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,H:"574dd5d2-46-"+s+"-"+r+",574dd5d2-45-"+s+"-"+r,I:e.p({threshold:[0,0],date:t.create_date}),J:"574dd5d2-45-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,K:"574dd5d2-48-"+s+"-"+r+",574dd5d2-47-"+s+"-"+r,L:e.p({threshold:[0,0],date:t.pay_date}),M:"574dd5d2-47-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,N:"574dd5d2-50-"+s+"-"+r+",574dd5d2-49-"+s+"-"+r,O:e.p({threshold:[0,0],date:t.cancel_date}),P:"574dd5d2-49-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,Q:e.t(t.provider_appid),R:"574dd5d2-51-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,S:e.t(t.appid),T:"574dd5d2-52-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,U:e.t(t.device_id),V:"574dd5d2-53-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,W:e.t(t.client_ip),X:"574dd5d2-54-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,Y:e.t(t.openid),Z:"574dd5d2-55-"+s+"-"+r+",574dd5d2-29-"+s+"-"+r,aa:a,ab:"574dd5d2-29-"+s+"-"+r+",574dd5d2-4-"+s}))),D:e.sr("table","574dd5d2-4-"+s+",574dd5d2-3"),E:"574dd5d2-4-"+s+",574dd5d2-3",F:e.p({loading:a,emptyText:r.message||a?"请求中...":"没有更多数据",border:!0,stripe:!0,type:""}),G:"574dd5d2-56-"+s+",574dd5d2-3",H:e.o((e=>d.current=e)),I:e.p({"show-icon":!0,"page-size":d.size,total:d.count,modelValue:d.current}),J:s,K:i})),{name:"d",path:"f",vueId:"574dd5d2-3"}),g:e.p({align:"center"}),h:e.o((e=>o.filterChange(e,"user_id"))),i:e.o((e=>o.sortChange(e,"user_id"))),j:e.p({align:"center",filterDefaultValue:n.filterDefaultValueUserId,"filter-type":"search",sortable:!0}),k:e.o((e=>o.filterChange(e,"provider"))),l:e.o((e=>o.filterChange(e,"provider_pay_type"))),m:e.o((e=>o.sortChange(e,"provider_pay_type"))),n:e.p({align:"center","filter-type":"search",sortable:!0}),o:e.o((e=>o.filterChange(e,"uni_platform"))),p:e.o((e=>o.sortChange(e,"uni_platform"))),q:e.p({align:"center","filter-type":"search",sortable:!0}),r:e.o((e=>o.filterChange(e,"status"))),s:e.o((e=>o.filterChange(e,"type"))),t:e.o((e=>o.sortChange(e,"type"))),v:e.p({align:"center","filter-type":"search",sortable:!0}),w:e.o((e=>o.filterChange(e,"order_no"))),x:e.o((e=>o.sortChange(e,"order_no"))),y:e.p({align:"center","filter-type":"search",sortable:!0}),z:e.o((e=>o.filterChange(e,"out_trade_no"))),A:e.o((e=>o.sortChange(e,"out_trade_no"))),B:e.p({align:"center","filter-type":"search",sortable:!0}),C:e.o((e=>o.filterChange(e,"transaction_id"))),D:e.o((e=>o.sortChange(e,"transaction_id"))),E:e.p({align:"center","filter-type":"search",sortable:!0}),F:e.o((e=>o.filterChange(e,"description"))),G:e.o((e=>o.sortChange(e,"description"))),H:e.p({align:"center","filter-type":"search",sortable:!0}),I:e.o((e=>o.filterChange(e,"total_fee",.01))),J:e.o((e=>o.sortChange(e,"total_fee"))),K:e.p({align:"center","filter-type":"range",sortable:!0}),L:e.o((e=>o.filterChange(e,"refund_fee",.01))),M:e.o((e=>o.sortChange(e,"refund_fee"))),N:e.p({align:"center","filter-type":"range",sortable:!0}),O:e.o((e=>o.filterChange(e,"refund_count"))),P:e.o((e=>o.sortChange(e,"refund_count"))),Q:e.p({align:"center","filter-type":"range",sortable:!0}),R:e.o((e=>o.sortChange(e,"user_order_success"))),S:e.p({align:"center",sortable:!0}),T:e.o((e=>o.filterChange(e,"create_date"))),U:e.o((e=>o.sortChange(e,"create_date"))),V:e.p({align:"center","filter-type":"timestamp",sortable:!0}),W:e.o((e=>o.filterChange(e,"pay_date"))),X:e.o((e=>o.sortChange(e,"pay_date"))),Y:e.p({align:"center","filter-type":"timestamp",sortable:!0}),Z:e.o((e=>o.filterChange(e,"cancel_date"))),aa:e.o((e=>o.sortChange(e,"cancel_date"))),ab:e.p({align:"center","filter-type":"timestamp",sortable:!0}),ac:e.o((e=>o.filterChange(e,"provider_appid"))),ad:e.o((e=>o.sortChange(e,"provider_appid"))),ae:e.p({align:"center","filter-type":"search",sortable:!0}),af:e.o((e=>o.filterChange(e,"appid"))),ag:e.o((e=>o.sortChange(e,"appid"))),ah:e.p({align:"center","filter-type":"search",sortable:!0}),ai:e.o((e=>o.filterChange(e,"device_id"))),aj:e.o((e=>o.sortChange(e,"device_id"))),ak:e.p({align:"center","filter-type":"search",sortable:!0}),al:e.o((e=>o.filterChange(e,"client_ip"))),am:e.o((e=>o.sortChange(e,"client_ip"))),an:e.p({align:"center","filter-type":"search",sortable:!0}),ao:e.o((e=>o.filterChange(e,"openid"))),ap:e.o((e=>o.sortChange(e,"openid"))),aq:e.p({align:"center","filter-type":"search",sortable:!0}),ar:e.p({align:"center"}),as:e.p({align:"center"}),at:e.p({align:"center"}),av:e.p({align:"center"}),aw:e.p({align:"center"}),ax:e.p({align:"center"}),ay:e.p({align:"center"}),az:e.p({align:"center"}),aA:e.p({align:"center"}),aB:e.p({align:"center"}),aC:e.p({align:"center"}),aD:e.p({align:"center"}),aE:e.p({align:"center"}),aF:e.p({align:"center"}),aG:e.p({align:"center"}),aH:e.p({align:"center"}),aI:e.p({align:"center"}),aJ:e.p({align:"center"}),aK:e.p({align:"center"}),aL:e.p({align:"center"}),aM:e.p({align:"center"}),aN:e.p({align:"center"}),aO:e.p({align:"center"}),aP:e.o(o.selectionChange),aQ:e.o(o.onPageChanged),aR:e.sr("udb","574dd5d2-3"),aS:e.o(o.onqueryload),aT:e.p({collection:n.collectionList,field:"user_id,nickname,provider,provider_pay_type,uni_platform,status,type,order_no,out_trade_no,transaction_id,device_id,client_ip,openid,description,err_msg,total_fee,refund_fee,refund_count,refund_list,provider_appid,appid,user_order_success,create_date,pay_date,notify_date,cancel_date",where:n.where,"page-data":"replace",orderby:n.orderby,getcount:!0,"page-size":n.options.pageSize,"page-current":n.options.pageCurrent,options:n.options,loadtime:"manual"}),aU:e.o(e.m((e=>n.refundFormData.refund_fee=e),{number:!0},!0)),aV:e.p({type:"text",placeholder:"请输入退款金额",clearable:!1,modelValue:n.refundFormData.refund_fee}),aW:e.t(n.refundFormData.max_refund_fee),aX:e.p({label:"退款金额",name:"refund_fee"}),aY:e.o((e=>n.refundFormData.refund_desc=e)),aZ:e.p({type:"textarea",placeholder:"请输入退款原因",clearable:!1,modelValue:n.refundFormData.refund_desc}),ba:e.p({label:"退款原因",name:"refund_desc"}),bb:e.o((e=>{o.confirmRefund(n.refundFormData)})),bc:e.sr("refundForm","574dd5d2-58,574dd5d2-57"),bd:e.p({modelValue:n.refundFormData,"label-position":"left",labelWidth:"100px",rules:n.refundFormRules}),be:e.sr("popup","574dd5d2-57"),bf:e.p({type:"center",animation:!1})}}],["__scopeId","data-v-574dd5d2"]]);wx.createPage(i);
