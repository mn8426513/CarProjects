"use strict";const t=require("../../../../../common/vendor.js"),e=require("../../../../../js_sdk/uni-stat/util.js"),a=require("../../../../../js_sdk/uni-stat/timeUtil.js"),i=require("../fieldsMap.js");let s=[];i.fieldsGroupMap.forEach((t=>{const e=t.group,a=t.title;e&&a&&s.push({_id:e,name:a,list:t.list})}));const r={props:{query:{type:[Object],default:function(){return{}}}},data:()=>({tableName:"uni-stat-pay-result",chartData:{},errorMessage:"",opts:{color:["#1890FF","#91CB74","#FAC858","#EE6666","#73C0DE","#3CA272","#FC8452","#9A60B4","#ea7ccc"],padding:[15,15,0,15],legend:{},enableScroll:!0,dataLabel:!1,xAxis:{disableGrid:!0,itemCount:24,fontSize:12,boundaryGap:"center"},yAxis:{gridType:"dash",dashLength:2,data:[{tofix:2}]},extra:{area:{type:"straight",opacity:.2,addLine:!0,width:2,gradient:!1}},legend:{position:"bottom"}},dateTabs:{time:[],timeStr:"",index:2,list:[{_id:1,name:"昨天",dimension:"hour"},{_id:0,name:"今天",dimension:"hour"},{_id:7,name:"最近七天",dimension:"day"},{_id:30,name:"最近30天",dimension:"day"},{_id:90,name:"最近90天",dimension:"day"},{_id:372,name:"月纬度",dimension:"month"},{_id:1116,name:"季纬度",dimension:"quarter"},{_id:4392,name:"年纬度",dimension:"year"}]},statTabs:{index:0,list:s},queryMode:0}),created(){this.getCloudDataDebounce=e.debounce((()=>{this.getCloudData()}),300),this.getCloudDataDebounce()},methods:{getCloudData(a={}){let i=this.query;if(!i.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="";let s=this.getWhere(),r={...i,...s},n=this.statTabs.list[this.statTabs.index].list;r=e.stringifyQuery(r,!0,["uni_platform"]);t.er.database().collection(this.tableName).where(r).field(`${e.stringifyField(n)}, start_time`).groupBy("start_time").groupField(e.stringifyGroupField(n)).orderBy("start_time","asc").limit(100).get({getCount:!0}).then((t=>{let{count:a,data:i}=t.result;i=e.fillTrendChartData(i,s,n),i=e.formatterData({fieldsMap:n,data:i,formatter:!1}),this.setChartData(i,n,s)})).catch((t=>{console.error(t)})).finally((()=>{}))},setChartData(t,e,a){let i={categories:[],series:[]};e.map(((t,e)=>{t.trendChart&&i.series.push({name:t.title,data:[]})}));for(const s of t){const t=this.formatDate(s.start_time,a.dimension);i.categories.push(t),e.map(((t,e)=>{if(t.trendChart){let a=Number(s[t.field]);i.series[e].data.push(a)}}))}this.chartData=i},formatDate(t,a){let i=new Date(t),s=i.getFullYear(),r=i.getMonth()+1;i.getDate();let n=i.getHours(),d=Math.floor((i.getMonth()+3)/3);return r<10&&(r="0"+r),"hour"===a?`${n}时`:"month"===a?`${s}-${r}`:"quarter"===a?`${s}/Q${d}`:"year"===a?`${s}`:e.parseDateTime(i)},datePickerChange(t){this.dateTabs.time=t,this.queryMode=1,this.getCloudData()},dateTabsChange(t,e){this.dateTabs.index=e,this.queryMode=0,this.getCloudData()},statTabsChange(t,e,a){this.statTabs.index=e,this.getCloudData({field:t,name:a})},getWhere(){let t=[],i=this.dateTabs.list[this.dateTabs.index]||{};if("number"==typeof i._id&&0===this.queryMode){let s=e.getTimeOfSomeDayAgo(i._id),r=a.timeUtil.getOffsetStartAndEnd("day",0).endTime;1==i._id&&(r=a.timeUtil.getOffsetStartAndEnd("day",0,s).endTime),t=[s,r]}else this.dateTabs.time&&(t=this.dateTabs.time);let s=i.dimension||"day";return this.dateTabs.timeStr=`${a.timeUtil.timeFormat(t[0])} ~ ${a.timeUtil.timeFormat(t[1])}`,this.dateTabs.time=t,{dimension:s,start_time:t}}},watch:{query:{deep:!0,handler(t){this.getCloudDataDebounce()}}},computed:{}};if(!Array){(t.resolveComponent("uni-stat-tabs")+t.resolveComponent("uni-datetime-picker")+t.resolveComponent("qiun-data-charts"))()}Math||((()=>"../../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js"))();const n=t._export_sfc(r,[["render",function(e,a,i,s,r,n){return{a:t.o(n.dateTabsChange),b:t.p({type:"box",current:r.dateTabs.index,tabs:r.dateTabs.list}),c:t.o(n.datePickerChange),d:t.o((t=>r.dateTabs.time=t)),e:t.p({type:"datetimerange",end:Date.now(),"return-type":"timestamp","clear-icon":!1,modelValue:r.dateTabs.time}),f:t.o(n.statTabsChange),g:t.p({type:"box",current:r.statTabs.index,tabs:r.statTabs.list}),h:t.p({type:"area",chartData:r.chartData,opts:r.opts,errorMessage:r.errorMessage})}}],["__scopeId","data-v-3dfdef5d"]]);wx.createComponent(n);
