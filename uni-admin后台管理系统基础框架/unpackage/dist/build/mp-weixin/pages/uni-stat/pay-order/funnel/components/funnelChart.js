"use strict";const e=require("../../../../../common/vendor.js"),t=require("../../../../../js_sdk/uni-stat/util.js"),a=require("../../../../../js_sdk/uni-stat/timeUtil.js"),i=require("../fieldsMap.js"),s={props:{query:{type:[Object],default:function(){return{}}}},data:()=>({tableName:"uni-stat-pay-result",fieldsMap:i.fieldsMap,chartData:{},errorMessage:"",notData:!1,opts:{color:["#1890FF","#91CB74","#FAC858","#EE6666","#73C0DE","#3CA272","#FC8452","#9A60B4","#ea7ccc"],padding:[15,15,0,15],extra:{funnel:{activeOpacity:.3,activeWidth:10,border:!0,borderWidth:2,borderColor:"#FFFFFF",fillOpacity:1,labelAlign:"right",linearType:"custom",minSize:20}}},dateTabs:{time:Date.now(),timeStr:"",index:0,list:[{_id:"day",name:"日维度"},{_id:"week",name:"周维度"},{_id:"month",name:"月维度"}]}}),created(){this.getCloudDataDebounce=t.debounce((()=>{this.getCloudData()}),400),this.getCloudDataDebounce()},methods:{calcPercentage:(e,t)=>t>0?parseFloat((e/t*100).toFixed(2)):0,getCloudData(){let a=this.query;if(!a.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="";let s=this.getWhere(),r={...a,...s};r=t.stringifyQuery(r,!1,["uni_platform"]);e.er.database().collection(this.tableName).where(r).field(`${t.stringifyField(i.fieldsMap)}, dimension, stat_date.date_str as stat_time, start_time`).groupBy("null").groupField(t.stringifyGroupField(i.fieldsMap)).get().then((e=>{let t=e.result.data;if(!t.length)return void(this.errorMessage="暂无数据");this.errorMessage="",t.map((e=>{for(let t in e)t.indexOf("_amount")>1&&(e[t]=Number((e[t]/100).toFixed(2)))}));let{activity_device_count:a=0,activity_user_count:i=0,pay_user_count:s=0}=t[0]||{};this.notData=!(a||i||s);let r={series:[{data:[{name:"活跃设备数量",value:a,centerText:`${a}`,labelText:"活跃设备数"},{name:"活跃用户数量",value:i,centerText:`${i}`,labelText:`活跃用户数（用户转化率：${this.calcPercentage(i,a)}%）`},{name:"支付用户数量",value:s,centerText:`${s}`,labelText:`支付用户数（支付转化率：${this.calcPercentage(s,i)}%）`}]}]};this.chartData=r}))},dateTabsChange(e,t){this.dateTabs.index=t,this.getCloudData()},datePickerChange(e){this.dateTabs.time=e,this.getCloudData()},getWhere(){let e=this.dateTabs.time,t=this.dateTabs.list[this.dateTabs.index]._id||"day",i=[];if("day"===t){let{startTime:t,endTime:s}=a.timeUtil.getOffsetStartAndEnd("day",0,e);i=[t,s]}else if("week"===t){let{startTime:t,endTime:s}=a.timeUtil.getOffsetStartAndEnd("week",0,e);i=[t,s]}else if("month"===t){let{startTime:t,endTime:s}=a.timeUtil.getOffsetStartAndEnd("month",0,e);i=[t,s]}return this.dateTabs.timeStr=`${a.timeUtil.timeFormat(i[0])} ~ ${a.timeUtil.timeFormat(i[1])}`,{dimension:t,start_time:i}}},watch:{query:{deep:!0,handler(e){this.getCloudDataDebounce()}}},computed:{}};if(!Array){(e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("qiun-data-charts"))()}Math||((()=>"../../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js"))();const r=e._export_sfc(s,[["render",function(t,a,i,s,r,n){return e.e({a:e.o(n.dateTabsChange),b:e.p({type:"box",current:r.dateTabs.index,tabs:r.dateTabs.list}),c:e.o(n.datePickerChange),d:e.o((e=>r.dateTabs.time=e)),e:e.p({type:"date",end:Date.now(),"return-type":"timestamp","clear-icon":!1,modelValue:r.dateTabs.time}),f:r.dateTabs.timeStr},r.dateTabs.timeStr?{g:e.t(r.dateTabs.timeStr)}:{},{h:!r.notData},r.notData?{}:{i:e.p({type:"funnel",chartData:r.chartData,opts:r.opts,errorMessage:r.errorMessage})})}],["__scopeId","data-v-91a7efea"]]);wx.createComponent(r);
