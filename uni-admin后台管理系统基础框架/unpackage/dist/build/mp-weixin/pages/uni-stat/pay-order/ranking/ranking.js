"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/validator/uni-pay-orders.js"),a=require("../../../../js_sdk/uni-stat/util.js"),n=require("../../../../js_sdk/uni-stat/timeUtil.js"),i=e.er.database(),r={ascending:"asc",descending:"desc"},o={data:()=>({collectionList:"uni-pay-orders",query:{appid:"",platform_id:"",uni_platform:"",version:"",pay_date:[],channel_code:""},where:"",orderby:"total_fee desc",orderByFieldName:"",selectedIndexs:[],options:{pageSize:20,pageCurrent:1,filterData:{},...t.enumConverter},imageStyles:{width:64,height:64},exportExcel:{filename:"价值用户排行.xls",type:"xls",fields:{"用户ID":"user_id","用户昵称":"nickname","支付金额":"total_fee","订单数量":"count"}},exportExcelData:[],dateTabs:{time:[],timeStr:"",index:null,list:[{_id:0,name:"今天"},{_id:1,name:"昨天"},{_id:7,name:"最近七天"},{_id:30,name:"最近30天"},{_id:90,name:"最近90天"}]}}),onLoad(){this._filter={}},onReady(){},methods:{payDatePicker(e){this.query.pay_date=e,this.search()},onqueryload(e){this.exportExcelData=e},getWhere(){let e="status>0",{pay_date:t,appid:a,version:n,uni_platform:i,channel_code:r}=this.query;return t&&2==t.length&&(e+=` && pay_date>=${t[0]} && pay_date<=${t[1]}`),a&&(e+=` && appid=='${a}'`),n&&(e+=` && stat_data.app_version=='${n}'`),i&&(e+=` && stat_data.platform=='${i}'`),r&&(e+=` && stat_data.channel=='${r}'`),e=e.trim(),console.log("where: ",e),e},search(){if(!this.query.appid)return;const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(t,a){e.index.navigateTo({url:t,events:{refreshData:()=>{this.loadData(a)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+r[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,a){this._filter[a]={type:e.filterType,value:e.filter};let n=t.filterToWhere(this._filter,i.command);Object.keys(n).length?this.where=n:this.where="",this.$nextTick((()=>{this.$refs.udb.loadData()}))},platformChange(e,t,a,n){this.query.version=0,this.query.uni_platform=n.code},nameFormat:e=>e.user_id?e.nickname?`${e.user_id}（${e.nickname}）`:e.user_id:"匿名用户",pageToUser(t){let{user_id:a}=t;e.index.navigateTo({url:`/pages/system/user/list?id=${a}`})},pageToOrder(t){let{user_id:a}=t;e.index.navigateTo({url:`/pages/uni-stat/pay-order/list/list?user_id=${a}`})},dateTabsChange(e,t){this.dateTabs.index=t;let i=a.getTimeOfSomeDayAgo(e),r=n.timeUtil.getOffsetStartAndEnd("day",0).endTime;1==e&&(r=n.timeUtil.getOffsetStartAndEnd("day",0,i).endTime),this.query.pay_date=[i,r]}},watch:{query:{deep:!0,handler(e){this.search()}}},computed:{versionQuery(){const{appid:e,uni_platform:t}=this.query;return a.stringifyQuery({appid:e,uni_platform:t})},channelQuery(){const{appid:e,platform_id:t}=this.query;return a.stringifyQuery({appid:e,platform_id:t})}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("download-excel")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("unicloud-db"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../components/download-excel/download-excel.js")+(()=>"../../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js"))();const s=e._export_sfc(o,[["render",function(t,a,n,i,r,o){return e.e({a:e.o(((...e)=>o.search&&o.search(...e))),b:e.p({fields:r.exportExcel.fields,data:r.exportExcelData,type:r.exportExcel.type,name:r.exportExcel.filename}),c:e.o((e=>r.query.appid=e)),d:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:r.query.appid}),e:e.o((e=>r.query.version_id=e)),f:e.p({collection:"opendb-app-versions",where:o.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:r.query.version_id}),g:e.o(o.platformChange),h:e.o((e=>r.query.platform_id=e)),i:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:r.query.platform_id}),j:r.query.platform_id&&-1===r.query.platform_id.indexOf("==")},r.query.platform_id&&-1===r.query.platform_id.indexOf("==")?{k:e.sr("version-select","39e78b9b-5"),l:e.o((e=>r.query.channel_code=e)),m:e.p({collection:"uni-stat-app-channels",where:o.channelQuery,field:"channel_code as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:r.query.channel_code})}:{},{n:e.o(o.dateTabsChange),o:e.p({type:"box",current:r.dateTabs.index,tabs:r.dateTabs.list}),p:e.o((e=>r.dateTabs.index=null)),q:e.o((e=>r.query.pay_date=e)),r:e.p({type:"datetimerange",end:Date.now(),"return-type":"timestamp","clear-icon":!0,modelValue:r.query.pay_date}),s:e.w((({data:t,pagination:a,loading:n,error:i,options:r},s,d)=>({a:"39e78b9b-11-"+d+",39e78b9b-10-"+d,b:"39e78b9b-12-"+d+",39e78b9b-10-"+d,c:"39e78b9b-13-"+d+",39e78b9b-10-"+d,d:"39e78b9b-14-"+d+",39e78b9b-10-"+d,e:"39e78b9b-10-"+d+",39e78b9b-9-"+d,f:e.f(t,((t,n,i)=>({a:e.t(parseInt(n+1+(a.current-1)*a.size)),b:"39e78b9b-16-"+d+"-"+i+",39e78b9b-15-"+d+"-"+i,c:e.t(o.nameFormat(t)),d:e.o((e=>o.pageToUser(t)),n),e:"39e78b9b-17-"+d+"-"+i+",39e78b9b-15-"+d+"-"+i,f:e.t((t.reality_fee/100).toFixed(2)),g:"39e78b9b-18-"+d+"-"+i+",39e78b9b-15-"+d+"-"+i,h:e.t(t.count),i:e.o((e=>o.pageToOrder(t)),n),j:"39e78b9b-19-"+d+"-"+i+",39e78b9b-15-"+d+"-"+i,k:n,l:"39e78b9b-15-"+d+"-"+i+",39e78b9b-9-"+d}))),g:e.sr("table","39e78b9b-9-"+d+",39e78b9b-8"),h:"39e78b9b-9-"+d+",39e78b9b-8",i:e.p({loading:n,emptyText:i.message||n?"请求中...":"没有更多数据",border:!0,stripe:!0,type:""}),j:"39e78b9b-20-"+d+",39e78b9b-8",k:e.o((e=>a.current=e)),l:e.p({"show-icon":!0,"page-size":a.size,total:a.count,modelValue:a.current}),m:d,n:s})),{name:"d",path:"s",vueId:"39e78b9b-8"}),t:e.p({align:"center"}),v:e.o((e=>o.sortChange(e,"user_id"))),w:e.p({align:"center",sortable:!0}),x:e.o((e=>o.sortChange(e,"reality_fee"))),y:e.p({align:"center",sortable:!0}),z:e.o((e=>o.sortChange(e,"count"))),A:e.p({align:"center",sortable:!0}),B:e.p({align:"center"}),C:e.p({align:"center"}),D:e.p({align:"center"}),E:e.p({align:"center"}),F:e.o(o.selectionChange),G:e.o(o.onPageChanged),H:e.sr("udb","39e78b9b-8"),I:e.o(o.onqueryload),J:e.p({collection:r.collectionList,field:"user_id,nickname,uni_platform,status,total_fee,refund_fee,appid,pay_date",where:r.where,"page-data":"replace",orderby:r.orderby,getcount:!0,"page-size":r.options.pageSize,"page-current":r.options.pageCurrent,groupby:"user_id","group-field":"sum(total_fee) as total_fee,sum(refund_fee) as refund_fee, sum(subtract(total_fee,refund_fee)) as reality_fee, sum(1) as count,last(nickname) as nickname",options:r.options,loadtime:"manual"})})}],["__scopeId","data-v-39e78b9b"]]);wx.createPage(s);
