"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/uni-stat/util.js"),i=require("./fieldsMap.js"),a={data:()=>({query:{dimension:"day",appid:"",platform_id:"",uni_platform:"",version_id:"",channel_id:"",start_time:[]},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:0,tableData:[],chartData:{},field:"new_user",fields:[{_id:"new_user",name:"新增留存",tooltip:"指定时间新增（即首次访问应用）用户，在之后的第N天，再次访问应用的用户数占比"},{_id:"active_user",name:"活跃留存",tooltip:"指定时间活跃（即访问应用）用户，在之后的第N天，再次访问应用的用户数占比"}],key:1,channelData:[],errorMessage:""}),computed:{fieldsMap(){const e=[{title:"active_user"===this.field?"活跃用户":"新增用户",field:`${this.field}_count`,stat:0}];return i.fieldsFactory(e)},fieldName(){let e="";return this.fields.forEach((t=>{t._id===this.field&&(e=t.name)})),e},keyName(){return this.keys.forEach((e=>{if(e._id===this.key)return e.name}))},keys:()=>[1,2,3,4,5,6,7,14,30].map((e=>({_id:e,name:`${e}天后`}))),channelQuery(){const e=this.query.platform_id;return t.stringifyQuery({platform_id:e})},versionQuery(){const{appid:e,uni_platform:i}=this.query;return t.stringifyQuery({appid:e,uni_platform:i})}},created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.query)}),300),this.getChannelData()},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}},key(){this.debounceGet()},field(){this.debounceGet()}},methods:{useDatetimePicker(){this.currentDateTab=-1},changeAppid(e){this.getChannelData(e,!1)},changePlatform(e,t,i,a){this.getChannelData(null,e),this.query.version_id=0,this.query.uni_platform=a.code},changeTimeRange(e,i){this.currentDateTab=i;const a=t.getTimeOfSomeDayAgo(e),n=t.getTimeOfSomeDayAgo(0)-1;this.query.start_time=[a,n]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTabelData(this.query)},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTabelData(this.query)},stringifyField(e,t,i){t&&(e=e.filter((e=>e.field===t))),i&&(e=e.filter((e=>e.field&&e.hasOwnProperty(i))));return e.map((e=>-1===e.stat?e.field:0===e.stat?`${e.field} as ${"temp_"+e.field}`:`retention.${this.field}.${e.field}.user_count as ${"temp_"+e.field}`)).join()},createStr(e="user_count",t,i,a){const n=t||[1,2,3,4,5,6,7,14,30],s=this.fields.map((e=>e._id));i=i||s;const r=n.map((t=>i.map((i=>`retention.${i}.${"d_"+t}.${e} as ${"d_"+t}`))));a&&r.push(a);return r.join()},getAllData(e){e.appid?(this.errorMessage="",this.getChartData(e,this.key,this.keyName),this.getTabelData(e)):this.errorMessage="请先选择应用"},getChartData(i,a=this.key,n="访问人数"){this.options,i=t.stringifyQuery(i,null,["uni_platform"]),this.createStr("user_count",[a],[this.field]);e.er.database().collection("uni-stat-result").where(i).field(`${this.stringifyField(this.fieldsMap,`d_${a}`)}, start_time`).groupBy("start_time").groupField(t.stringifyGroupField(this.fieldsMap,`d_${a}`)).orderBy("start_time","asc").get({getCount:!0}).then((e=>{let{count:i,data:n}=e.result;const s={categories:[],series:[{name:`${a}天后${this.fieldName}`,data:[]}]};for(const r of n){const e=t.formatDate(r.start_time,"day"),i=r[`d_${a}`];s.series[0].data.push(i),s.categories.push(e)}this.chartData=s})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getTabelData(i){const{pageCurrent:a}=this.options;i=t.stringifyQuery(i,null,["uni_platform"]);const n=this.field+"_count";this.createStr("user_rate","",[this.field],n),this.loading=!0;e.er.database().collection("uni-stat-result").where(i).field(this.stringifyField(this.fieldsMap)).groupBy("start_time").groupField(t.stringifyGroupField(this.fieldsMap)).orderBy("start_time","desc").skip((a-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:i,data:a}=e.result;for(const n of a)t.mapfields(this.fieldsMap,n,n);this.options.total=i,this.tableData=[],this.tableData=a})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getChannelData(t,i){this.query.channel_id="";const a=e.er.database(),n={};(t=t||this.query.appid)&&(n.appid=t),(i=i||this.query.platform_id)&&(n.platform_id=i);let s=a.collection("uni-stat-app-platforms").field("_id, name").getTemp(),r=a.collection("uni-stat-app-channels").where(n).field("_id, channel_name, create_time, platform_id").getTemp();a.collection(r,s).orderBy("platform_id","asc").get().then((e=>{let t=e.result.data,i=[];if(t.length>0){let e;for(let a in t)e=t[a].channel_name?t[a].channel_name:"默认",t[a].platform_id.length>0&&(e=t[a].platform_id[0].name+"-"+e),i.push({value:t[a]._id,text:e})}this.channelData=i})).catch((e=>{console.error(e)})).finally((()=>{}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../../components/fix-window/fix-window.js"))();const n=e._export_sfc(a,[["render",function(t,i,a,n,s,r){return e.e({a:e.o(r.changeAppid),b:e.o((e=>s.query.appid=e)),c:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:s.query.appid}),d:e.o((e=>s.query.version_id=e)),e:e.p({collection:"opendb-app-versions",where:r.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:s.query.version_id}),f:e.o(r.changeTimeRange),g:e.p({label:"日期选择",current:s.currentDateTab,mode:"date",yesterday:!1}),h:s.currentDateTab<0&&s.query.start_time.length?1:"",i:e.o(r.useDatetimePicker),j:e.o((e=>s.query.start_time=e)),k:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:s.query.start_time}),l:e.o(r.changePlatform),m:e.o((e=>s.query.platform_id=e)),n:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:s.query.platform_id}),o:s.query.platform_id&&-1===s.query.platform_id.indexOf("==")},s.query.platform_id&&-1===s.query.platform_id.indexOf("==")?{p:e.sr("version-select","186e8670-6"),q:e.o((e=>s.query.channel_id=e)),r:e.p({collection:"uni-stat-app-channels",where:r.channelQuery,field:"_id as value, channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:s.query.channel_id})}:{},{s:e.o((e=>s.field=e)),t:e.p({type:"boldLine",tabs:s.fields,tooltip:!0,modelValue:s.field}),v:e.o((e=>s.key=e)),w:e.p({type:"box",tabs:r.keys,modelValue:s.key}),x:e.p({type:"area",chartData:s.chartData,echartsH5:!0,echartsApp:!0,errorMessage:s.errorMessage}),y:e.p({type:"info"}),z:e.f(r.fieldsMap,((t,i,a)=>e.e({a:t.title},t.title?{b:e.t(t.title),c:i,d:"186e8670-13-"+a+",186e8670-12",e:e.p({align:"center"})}:{},{f:i}))),A:e.f(s.tableData,((t,i,a)=>({a:e.f(r.fieldsMap,((i,n,s)=>e.e({a:i.title},i.title?{b:e.t(t[i.field]?t[i.field]:""),c:n,d:e.n(/[d|w|m]_\d/.test(i.field)&&[t[i.field]?"uni-stat-table-bg":""]),e:"186e8670-15-"+a+"-"+s+",186e8670-14-"+a,f:e.p({align:"center"})}:{},{g:n}))),b:i,c:"186e8670-14-"+a+",186e8670-11"}))),B:e.p({loading:s.loading,stripe:!0,emptyText:s.errorMessage||t.$t("common.empty")}),C:e.o(r.changePageCurrent),D:e.o(r.changePageSize),E:e.p({"show-icon":!0,"show-page-size":!0,"page-size":s.options.pageSize,current:s.options.pageCurrent,total:s.options.total})})}]]);wx.createPage(n);
