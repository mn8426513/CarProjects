"use strict";const t=require("../../../../common/vendor.js"),e=require("../../../../js_sdk/uni-stat/util.js"),a={data:()=>({query:{dimension:"day",appid:"",version_id:"",start_time:e.getTimeOfSomeDayAgo(0)},platforms:[],dayChartsData:[],monChartsData:[]}),created(){this.debounceGet=e.debounce((()=>{this.getChartData(this.query),this.getRangeCountData(this.query,"month")}),300)},watch:{query:{deep:!0,handler(t){this.debounceGet()}}},computed:{chartsData(){return[...this.dayChartsData,...this.monChartsData]},versionQuery(){const{appid:t}=this.query;return e.stringifyQuery({appid:t})}},methods:{getChartData(a,s="day"){a=JSON.parse(JSON.stringify(a));const r=e.getTimeOfSomeDayAgo(0);if(a.start_time>=r){const t=(new Date).getTime();a.start_time=[r,t],a=e.stringifyQuery(a,!0)}else a=e.stringifyQuery(a);t.er.database().collection("uni-stat-result").where(a).field("active_user_count,new_user_count,total_users,platform_id").groupBy("platform_id").groupField(`sum(active_user_count) as ${s}_active_user_count, sum(new_user_count) as ${s}_new_user_count, max(total_users) as ${s}_total_users`).get().then((t=>{const e=t.result.data;this.initChartOption(e,"dayChartsData")}))},getRangeCountData(a,s){a=e.stringifyQuery(a);t.er.database().collection("uni-stat-result").where(a).field(`active_user_count, new_user_count, platform_id, ${s}(add(new Date(0),start_time), "Asia/Shanghai") as ${s},year(add(new Date(0),start_time), "Asia/Shanghai") as year`).groupBy(`year, ${s?s+",":""}platform_id`).groupField(`sum(active_user_count) as ${s}_active_user_count, sum(new_user_count) as ${s}_new_user_count`).orderBy(`year asc, ${s} asc`).get().then((t=>{const e=t.result.data;this.initChartOption(e,"monChartsData","month")}))},initChartOption(e,a,s="day"){t.er.database().collection("uni-stat-app-platforms").get().then((t=>{const r=[{field:`${s}_new_user_count`,title:("day"===s?"日":"月")+"新增用户对比",series:[{data:[]}]},{field:`${s}_active_user_count`,title:("day"===s?"日":"月")+"活跃用户对比",series:[{data:[]}]}];"day"===s&&r.unshift({field:"day_total_users",title:"总用户数对比",series:[{data:[]}]}),this[a]=r;const i=t.result.data,n={};i.forEach((t=>{n[t._id]=t.name}));for(const s of this[a]){const t=s.series[0].data,a=JSON.parse(JSON.stringify(n));for(const r of e)for(const e in r)if(s.field===e){const s=r.platform_id,i={name:a[s],value:r[e]};t.push(i),delete a[s]}for(const e in a){const s={name:a[e],value:0};t.push(s)}}}))}}};if(!Array){(t.resolveComponent("uni-stat-breadcrumb")+t.resolveComponent("uni-data-select")+t.resolveComponent("uni-datetime-picker")+t.resolveComponent("qiun-data-charts")+t.resolveComponent("fix-window"))()}Math||((()=>"../../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../../components/fix-window/fix-window.js"))();const s=t._export_sfc(a,[["render",function(e,a,s,r,i,n){return{a:t.o((t=>i.query.appid=t)),b:t.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:i.query.appid}),c:t.o((t=>i.query.version_id=t)),d:t.p({collection:"opendb-app-versions",where:n.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:i.query.version_id}),e:i.query.start_time?1:"",f:t.o((t=>i.query.start_time=t)),g:t.p({type:"date",returnType:"timestamp",clearIcon:!1,modelValue:i.query.start_time}),h:t.f(n.chartsData,((e,a,s)=>({a:t.t(n.chartsData[a].title),b:"0420636a-4-"+s,c:t.p({type:"ring",chartData:n.chartsData[a],echartsH5:!0,echartsApp:!0}),d:a})))}}]]);wx.createPage(s);
