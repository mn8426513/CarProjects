"use strict";const e=require("../../../common/vendor.js"),t=require("../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),n={data:()=>({fieldsMap:a.fieldsMap,formData:{event_key:"",device_id:""},query:{appid:"",platform_id:"",uni_platform:"",platform:"",channel_id:"",channel:"",version_id:"",version:"",create_time:[],event_key:"",device_id:""},options:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:1,tableData:[],panelData:[],queryId:"",updateValue:"",channelData:[],errorMessage:""}),computed:{channelQuery(){const e=this.query.platform_id;return t.stringifyQuery({platform_id:e})},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a})}},created(){this.debounceGet=t.debounce((()=>this.getAllData())),this.getChannelData()},watch:{query:{deep:!0,handler(e){this.options.pageCurrent=1,this.debounceGet()}}},methods:{changeFormData(e,t){this.query[t]=e},useDatetimePicker(){this.currentDateTab=-1},changeAppid(e){this.getChannelData(e,!1)},changeTimeRange(e,a){this.currentDateTab=a;const n=t.getTimeOfSomeDayAgo(e),i=t.getTimeOfSomeDayAgo(0)-1;this.query.create_time=[n,i]},changePageCurrent(e){this.options.pageCurrent=e.current,this.getTableData()},changePageSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.getTableData()},getAllData(e){this.getTableData(e)},changePlatform(e,t,a,n){this.getChannelData(null,e),this.query.version_id=0,this.query.uni_platform=n.code,this.query.platform=n.code},changeVersion(e){e||(e=""),e.split("---"),this.query.version=e.split("---")[0],this.query.platform=e.split("---")[1]},changeChannel(e){e||(e=""),e.split("---"),this.query.channel=e.split("---")[0]},getTableData(n=t.stringifyQuery(this.query,null,["uni_platform","platform_id","version_id","channel_id"])){if(!this.query.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="";const{pageCurrent:i}=this.options;this.loading=!0;const o=e.er.database();let r=[o.collection("uni-stat-event-logs").where(n).getTemp(),o.collection("uni-stat-app-platforms").getTemp()];o.collection(...r).orderBy("create_time","desc").skip((i-1)*this.options.pageSize).limit(this.options.pageSize).get({getCount:!0}).then((e=>{const{count:n,data:i}=e.result;this.tableData=[],this.options.total=n;for(const o of i)o.create_time=t.parseDateTime(o.create_time,"dateTime"),o.platform=o.platform&&o.platform[0].name,t.mapfields(a.fieldsMap,o,o),this.tableData.push(o)})).catch((e=>{console.error(e)})).finally((()=>{this.loading=!1}))},getChannelData(t,a){if(!this.query.appid)return void(this.errorMessage="请先选择应用");this.errorMessage="",this.query.channel_id="";const n=e.er.database(),i={};(t=t||this.query.appid)&&(i.appid=t),(a=a||this.query.platform_id)&&(i.platform_id=a);let o=n.collection("uni-stat-app-platforms").field("_id, name").getTemp(),r=n.collection("uni-stat-app-channels").where(i).field("_id, channel_name, create_time, platform_id").getTemp();n.collection(r,o).orderBy("platform_id","asc").get().then((e=>{let t=e.result.data,a=[];if(t.length>0){let e;for(let n in t)e=t[n].channel_name?t[n].channel_name:"默认",t[n].platform_id.length>0&&(e=t[n].platform_id[0].name+"-"+e),a.push({value:t[n]._id,text:e})}this.channelData=a})).catch((e=>{console.error(e)})).finally((()=>{}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-link")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../uni_modules/uni-link/components/uni-link/uni-link.js")+(()=>"../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../../components/fix-window/fix-window.js"))();const i=e._export_sfc(n,[["render",function(t,a,n,i,o,r){return e.e({a:e.p({href:"https://ask.dcloud.net.cn/article/36304",text:"自定义事件说明>>"}),b:e.o((e=>o.query.appid=e)),c:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:o.query.appid}),d:e.o(r.changeVersion),e:e.o((e=>o.query.version_id=e)),f:e.p({collection:"opendb-app-versions",where:r.versionQuery,field:"concat(version, '---',uni_platform) as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:o.query.version_id}),g:e.o(r.changeTimeRange),h:e.p({label:"日期选择",current:o.currentDateTab,mode:"date"}),i:o.currentDateTab<0&&o.query.create_time.length?1:"",j:e.o(r.useDatetimePicker),k:e.o((e=>o.query.create_time=e)),l:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:o.query.create_time}),m:e.o(r.changePlatform),n:e.o((e=>o.query.platform_id=e)),o:e.p({label:"平台选择",type:"boldLine",mode:"platform",modelValue:o.query.platform_id}),p:o.query.platform_id&&-1===o.query.platform_id.indexOf("==")},o.query.platform_id&&-1===o.query.platform_id.indexOf("==")?{q:e.sr("version-select","5c707a16-7"),r:e.o(r.changeChannel),s:e.o((e=>o.query.channel_id=e)),t:e.p({collection:"uni-stat-app-channels",where:r.channelQuery,field:"concat(channel_code, '---',channel_name) as value,  channel_name as text",orderby:"text asc",label:"渠道/场景值选择",modelValue:o.query.channel_id})}:{},{v:e.o((e=>r.changeFormData(e,"event_key"))),w:e.o((e=>r.changeFormData("","event_key"))),x:e.o((e=>o.formData.event_key=e)),y:e.p({placeholder:"事件ID",modelValue:o.formData.event_key}),z:e.o((e=>r.changeFormData(e,"device_id"))),A:e.o((e=>r.changeFormData("","device_id"))),B:e.o((e=>o.formData.device_id=e)),C:e.p({placeholder:"设备标识",modelValue:o.formData.device_id}),D:e.f(o.fieldsMap,((t,a,n)=>e.e({a:t.title},t.title?{b:e.t(t.title),c:a,d:"5c707a16-12-"+n+",5c707a16-11",e:e.p({align:"center"})}:{},{f:a}))),E:e.f(o.tableData,((t,a,n)=>({a:e.f(o.fieldsMap,((a,i,o)=>({a:e.t(void 0!==t[a.field]?t[a.field]:"-"),b:i,c:"5c707a16-14-"+n+"-"+o+",5c707a16-13-"+n}))),b:a,c:"5c707a16-13-"+n+",5c707a16-10"}))),F:e.p({align:"center"}),G:e.p({loading:o.loading,border:!0,stripe:!0,emptyText:o.errorMessage||t.$t("common.empty")}),H:e.o(r.changePageCurrent),I:e.o(r.changePageSize),J:e.p({"show-icon":!0,"show-page-size":!0,"page-size":o.options.pageSize,current:o.options.pageCurrent,total:o.options.total}),K:e.sr("inputClose","5c707a16-17,5c707a16-16"),L:e.o(t.editName),M:e.o((e=>o.updateValue=e)),N:e.p({mode:"input",title:"请编辑名称",placeholder:"请输入内容",modelValue:o.updateValue}),O:e.sr("inputDialog","5c707a16-16"),P:e.p({type:"dialog",maskClick:!0})})}]]);wx.createPage(i);
