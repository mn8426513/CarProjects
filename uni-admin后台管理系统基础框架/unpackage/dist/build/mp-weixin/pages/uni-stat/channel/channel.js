"use strict";const e=require("../../../common/vendor.js"),t=require("../../../js_sdk/uni-stat/util.js"),a=require("./fieldsMap.js"),i={data:()=>({fieldsMap:a.fieldsMap,query:{dimension:"day",appid:"",uni_platform:"android",platform_id:"",version_id:"",start_time:[]},paginationOptions:{pageSize:20,pageCurrent:1,total:0},loading:!1,currentDateTab:1,days:0,tableData:[],panelData:a.fieldsMap.filter((e=>e.hasOwnProperty("value"))),chartData:{},chartTab:"new_device_count",queryId:"",updateValue:"",errorMessage:""}),computed:{chartTabs(){const e=[];return a.fieldsMap.forEach((t=>{const{field:a,title:i}=t,n=t.hasOwnProperty("value");a&&i&&n&&e.push({_id:a,name:i})})),e},queryStr(){return t.stringifyQuery(this.query,!0)},dimension(){return t.maxDeltaDay(this.query.start_time,1)?"hour":"day"},versionQuery(){const{appid:e,uni_platform:a}=this.query;return t.stringifyQuery({appid:e,uni_platform:a,type:"native_app"})}},created(){this.debounceGet=t.debounce((()=>{this.getAllData(this.queryStr)}),300)},watch:{query:{deep:!0,handler(e){this.paginationOptions.pageCurrent=1,this.debounceGet()}}},methods:{useDatetimePicker(){this.currentDateTab=-1},changePlatform(e,t,a,i){this.query.version_id=0,this.query.uni_platform=i.code},changeTimeRange(e,a){this.currentDateTab=a;let i,n;i=t.getTimeOfSomeDayAgo(e),n=e?t.getTimeOfSomeDayAgo(0)-1:t.getTimeOfSomeDayAgo(0)+864e5-1,this.query.start_time=[i,n]},changePageCurrent(e){this.paginationOptions.pageCurrent=e.current,this.getTableData()},changePageSize(e){this.paginationOptions.pageSize=e,this.paginationOptions.pageCurrent=1,this.getTableData()},changeChartTab(e,t,a){this.getChartData(e,a)},getAllData(e){this.query.appid?(this.errorMessage="",this.getPanelData(),this.getChartData(),this.getTableData()):this.errorMessage="请先选择应用"},getChartData(i=this.chartTab){let n=t.stringifyQuery(this.query,!1,["uni_platform"]);this.paginationOptions;e.er.database().collection("uni-stat-result").where(n).field(`${t.stringifyField(a.fieldsMap,i)}, start_time, channel_id`).groupBy("channel_id,start_time").groupField(t.stringifyGroupField(a.fieldsMap,i)).orderBy("start_time","asc").get({getCount:!0}).then((e=>{const{count:n,data:o}=e.result,s={categories:[],series:[{name:"暂无数据",data:[]}]},r=s.categories;if("hour"===this.dimension)for(let t=0;t<24;++t){const e=t<10?"0"+t:t,a=`${e}:00 ~ ${e}:59`;r.push(a)}const l=[];o.forEach((e=>{l.indexOf(e.channel_id)<0&&l.push(e.channel_id)}));let p=[];this.getChannels().then((e=>{p=e.result.data})).finally((()=>{l.forEach(((e,n)=>{const l=p.find((t=>t._id===e)),u=s.series[n]={name:l&&l.channel_name||"未知",data:[]};if("hour"===this.dimension)for(let t=0;t<24;++t)u.data[t]=0;let d=a.fieldsMap.filter((e=>e.field===i));d=JSON.parse(JSON.stringify(d)),delete d[0].value,d[0].formatter="";for(const a of o){t.mapfields(d,a,a);let n=a.start_time;const o=t.formatDate(n,this.dimension);let s=a[i];const l=r.indexOf(o);e===a.channel_id&&(l<0?(r.push(o),u.data.push(s)):u.data[l]=s)}})),s.series=s.series.sort(((e,t)=>e.name.localeCompare(t.name))),this.chartData=s}))})).catch((e=>{console.error(e)})).finally((()=>{}))},getChannels(){return e.er.database().collection("uni-stat-app-channels").where(t.stringifyQuery({appid:this.query.appid,platform_id:this.query.platform_id})).get()},getTableData(){const i=t.stringifyQuery(this.query,!1,["uni_platform"]),{pageCurrent:n}=this.paginationOptions;this.loading=!0;e.er.database().collection("uni-stat-result").where(i).field(`${t.stringifyField(a.fieldsMap)},appid, channel_id`).groupBy("appid, channel_id").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("new_device_count","desc").skip((n-1)*this.paginationOptions.pageSize).limit(this.paginationOptions.pageSize).get({getCount:!0}).then((e=>{const{count:i,data:n}=e.result;this.getChannels().then((e=>{const t=e.result.data;for(const a of n)t.forEach((e=>{a.channel_id===e._id&&(a.channel_code=e.channel_code,a.channel_name=e.channel_name)}))})).finally((()=>{for(const e of n)t.mapfields(a.fieldsMap,e,e,"total_");this.tableData=[],this.paginationOptions.total=i,this.tableData=n,this.loading=!1}))})).catch((e=>{console.error(e),this.loading=!1}))},createStr(e,t,a="total_"){const i=[];return e.forEach((e=>{if(field.hasOwnProperty("value")){const n=e.field;i.push(`${t}(${n}) as ${a+n}`)}})),i.join()},getPanelData(){let i=JSON.parse(JSON.stringify(this.query));i.dimension="day";let n=t.stringifyQuery(i,!1,["uni_platform"]);e.er.database().collection("uni-stat-result").where(n).field(t.stringifyField(a.fieldsMap)).groupBy("appid").groupField(t.stringifyGroupField(a.fieldsMap)).orderBy("start_time","desc").get().then((e=>{const n=e.result.data[0];n&&(n.total_devices=0),t.getFieldTotal.call(this,i),this.panelData=[],this.panelData=t.mapfields(a.fieldsMap,n)}))},inputDialogToggle(e,t){this.queryId=e,this.updateValue=t,this.$refs.inputDialog.open()},editName(t){e.er.database().collection("uni-stat-app-channels").where({channel_code:this.queryId}).update({channel_name:t}).then((t=>{e.index.showToast({title:"修改成功"}),this.getTableData()})).catch((t=>{e.index.showModal({content:t.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-link")+e.resolveComponent("uni-data-select")+e.resolveComponent("uni-stat-tabs")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-stat-panel")+e.resolveComponent("qiun-data-charts")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-icons")+e.resolveComponent("uni-td")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup")+e.resolveComponent("fix-window"))()}Math||((()=>"../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../uni_modules/uni-link/components/uni-link/uni-link.js")+(()=>"../../../uni_modules/uni-data-select/components/uni-data-select/uni-data-select.js")+(()=>"../../../components/uni-stat-tabs/uni-stat-tabs.js")+(()=>"../../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../../components/uni-stat-panel/uni-stat-panel.js")+(()=>"../../../uni_modules/qiun-data-charts/components/qiun-data-charts/qiun-data-charts.js")+(()=>"../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../../components/fix-window/fix-window.js"))();const n=e._export_sfc(i,[["render",function(t,a,i,n,o,s){return{a:e.p({href:"https://ask.dcloud.net.cn/article/35974",text:"支持Android App多渠道统计。设置App渠道包的方法，请参考 https://ask.dcloud.net.cn/article/35974。"}),b:e.o((e=>o.query.appid=e)),c:e.p({collection:"opendb-app-list",field:"appid as value, name as text",orderby:"text asc",defItem:1,label:"应用选择",clear:!1,modelValue:o.query.appid}),d:e.o((e=>o.query.version_id=e)),e:e.p({collection:"opendb-app-versions",storage:!1,where:s.versionQuery,field:"_id as value, version as text, uni_platform as label, create_date as date",format:"{label} - {text}",orderby:"date desc",label:"版本选择",modelValue:o.query.version_id}),f:e.o(s.changePlatform),g:e.o((e=>o.query.platform_id=e)),h:e.p({label:"平台选择",type:"boldLine",mode:"platform-channel",all:!1,modelValue:o.query.platform_id}),i:e.o(s.changeTimeRange),j:e.p({label:"日期选择",current:o.currentDateTab,mode:"date"}),k:o.currentDateTab<0&&o.query.start_time.length?1:"",l:e.o(s.useDatetimePicker),m:e.o((e=>o.query.start_time=e)),n:e.p({type:"datetimerange",end:(new Date).getTime(),returnType:"timestamp",clearIcon:!1,modelValue:o.query.start_time}),o:e.p({items:o.panelData}),p:e.o(s.changeChartTab),q:e.o((e=>o.chartTab=e)),r:e.p({type:"box",tabs:s.chartTabs,modelValue:o.chartTab}),s:e.p({type:"area",chartData:o.chartData,echartsH5:!0,echartsApp:!0,tooltipFormat:"tooltipCustom",errorMessage:o.errorMessage}),t:e.p({color:"",href:"https://ask.dcloud.net.cn/article/35974",text:"如何自定义渠道包?"}),v:e.f(o.fieldsMap.slice(0,o.fieldsMap.length-1),((t,a,i)=>e.e({a:t.title},t.title?{b:e.t(t.title),c:a,d:"04f3bcb0-13-"+i+",04f3bcb0-12",e:e.p({align:"center"})}:{},{f:a}))),w:e.f(o.tableData,((t,a,i)=>({a:e.f(o.fieldsMap.slice(0,o.fieldsMap.length-1),((a,n,o)=>e.e({a:a.title&&1===n},a.title&&1===n?{b:e.t(t[a.field]?t[a.field]:"-"),c:e.o((e=>s.inputDialogToggle(t.channel_code,t.channel_name)),n),d:"04f3bcb0-16-"+i+"-"+o+",04f3bcb0-15-"+i+"-"+o,e:e.p({type:"compose",color:"#2979ff",size:"25"}),f:a.field,g:"04f3bcb0-15-"+i+"-"+o+",04f3bcb0-14-"+i}:{i:e.t(void 0!==t[a.field]?t[a.field]:"-"),j:a.field,k:"04f3bcb0-17-"+i+"-"+o+",04f3bcb0-14-"+i,l:e.p({align:"center"})},{h:a.title,m:n}))),b:a,c:"04f3bcb0-14-"+i+",04f3bcb0-11"}))),x:e.p({loading:o.loading,border:!0,stripe:!0,emptyText:o.errorMessage||t.$t("common.empty")}),y:e.o(s.changePageCurrent),z:e.o(s.changePageSize),A:e.p({"show-icon":!0,"show-page-size":!0,"page-size":o.paginationOptions.pageSize,current:o.paginationOptions.pageCurrent,total:o.paginationOptions.total}),B:e.sr("inputClose","04f3bcb0-20,04f3bcb0-19"),C:e.o(s.editName),D:e.o((e=>o.updateValue=e)),E:e.p({mode:"input",title:"请编辑名称",placeholder:"请输入内容",modelValue:o.updateValue}),F:e.sr("inputDialog","04f3bcb0-19"),G:e.p({type:"dialog",maskClick:!0})}}]]);wx.createPage(n);
