"use strict";const e=require("../../../common/vendor.js"),t=require("../../../js_sdk/validator/uni-id-users.js"),a=e.er.database(),i=["username","role.role_name","mobile","email"],n={ascending:"asc",descending:"desc"},o={data:()=>({collectionList:[a.collection("uni-id-users").field("ali_openid,apple_openid,avatar,avatar_file,comment,dcloud_appid,department_id,email,email_confirmed,gender,invite_time,inviter_uid,last_login_date,last_login_ip,mobile,mobile_confirmed,my_invite_code,nickname,role,score,status,username,wx_unionid,qq_unionid,tags").getTemp(),a.collection("uni-id-roles").field("role_id, role_name").getTemp()],query:"",where:"",orderby:"last_login_date desc",orderByFieldName:"",selectedIndexs:[],pageSizeIndex:0,pageSizeOption:[20,50,100,500],tags:{},managerTags:[],queryTagid:"",queryUserId:"",options:{pageSize:20,pageCurrent:1,filterData:{status_localdata:[{text:"正常",value:0,checked:!0},{text:"禁用",value:1},{text:"审核中",value:2},{text:"审核拒绝",value:3}]},...t.enumConverter},imageStyles:{width:64,height:64},exportExcel:{filename:"uni-id-users.xls",type:"xls",fields:{"用户名":"username","手机号码":"mobile","用户状态":"status","邮箱":"email","角色":"role",last_login_date:"last_login_date"}},exportExcelData:[],noAppidWhatShouldIDoLink:"https://uniapp.dcloud.net.cn/uniCloud/uni-id?id=makeup-dcloud-appid",smsCondition:{}}),onLoad(e){this._filter={};const t=e.tagid,a=e.id;if(t){this.queryTagid=t;const e={filterType:"select",filter:[t]};this.filterChange(e,"tags")}if(a){this.queryUserId=a;const e={filterType:"select",filter:[a]};this.filterChange(e,"_id")}},onReady(){this.loadTags(),this.queryTagid||this.queryUserId||this.$refs.udb.loadData()},computed:{tagsData(){const e=[];for(const t in this.tags){const a={value:t,text:this.tags[t]};t===this.queryTagid&&(a.checked=!0),e.push(a)}return e},smsReceiver(){if(this.selectedIndexs.length){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))}}},methods:{onqueryload(e){for(let t=0;t<e.length;t++){let a=e[t];const i=a.role.map((e=>e.role_name));a.role=i.join("、");const n=a.tags&&a.tags.map((e=>this.tags[e]));a.tags=n,Array.isArray(a.dcloud_appid)&&(a.dcloud_appid=a.dcloud_appid.join("、")),a.last_login_date=this.$formatDate(a.last_login_date)}this.exportExcelData=e},changeSize(e){this.options.pageSize=e,this.options.pageCurrent=1,this.$nextTick((()=>{this.loadData()}))},openTagsPopup(){this.$refs.tagsPopup.open()},closeTagsPopup(){this.$refs.tagsPopup.close()},getWhere(){const e=this.query.trim();if(!e)return"";const t=new RegExp(e,"i");return console.log(JSON.stringify(a.command.or(i.map((e=>({[e]:t})))))),a.command.or(i.map((e=>({[e]:t}))))},search(){const e=this.getWhere();this.where=e,this.$nextTick((()=>{this.loadData()}))},loadData(e=!0){this.$refs.udb.loadData({clear:e})},onPageChanged(e){this.selectedIndexs.length=0,this.$refs.table.clearSelection(),this.$refs.udb.loadData({current:e.current})},navigateTo(t,a){e.index.navigateTo({url:t,events:{refreshData:()=>{this.loadTags(),this.loadData(a)}}})},selectedItems(){let e=this.$refs.udb.dataList;return this.selectedIndexs.map((t=>e[t]._id))},delTable(){this.$refs.udb.remove(this.selectedItems(),{success:e=>{this.$refs.table.clearSelection()}})},selectionChange(e){this.selectedIndexs=e.detail.index},confirmDelete(e){this.$refs.udb.remove(e,{success:e=>{this.$refs.table.clearSelection()}})},sortChange(e,t){this.orderByFieldName=t,e.order?this.orderby=t+" "+n[e.order]:this.orderby="",this.$refs.table.clearSelection(),this.$nextTick((()=>{this.$refs.udb.loadData()}))},filterChange(e,i){this._filter[i]={type:e.filterType,value:e.filter};let n=t.filterToWhere(this._filter,a.command);Object.keys(n).length?this.where=n:this.where="",Object.keys(this._filter).length?this.smsCondition=this._filter:this.smsCondition={},this.$nextTick((()=>{this.$refs.udb.loadData()}))},loadTags(){a.collection("uni-id-tag").limit(500).get().then((e=>{e.result.data.map((e=>{this.$set(this.tags,e.tagid,e.name)}))})).catch((t=>{e.index.showModal({title:"提示",content:t.message,showCancel:!1})}))},managerMultiTag(){const t=this.selectedItems();a.collection("uni-id-users").where({_id:a.command.in(t)}).update({tags:this.managerTags}).then((()=>{e.index.showToast({title:"修改标签成功",duration:2e3}),this.$refs.table.clearSelection(),this.managerTags=[],this.loadData(),this.closeTagsPopup()})).catch((t=>{e.index.showModal({content:t.message||"请求服务失败",showCancel:!1})})).finally((t=>{e.index.hideLoading()}))}}};if(!Array){(e.resolveComponent("uni-stat-breadcrumb")+e.resolveComponent("uni-th")+e.resolveComponent("uni-tr")+e.resolveComponent("uni-td")+e.resolveComponent("uni-link")+e.resolveComponent("uni-tag")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-table")+e.resolveComponent("uni-pagination")+e.resolveComponent("unicloud-db")+e.resolveComponent("fix-window")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../../components/uni-stat-breadcrumb/uni-stat-breadcrumb.js")+(()=>"../../../uni_modules/uni-table/components/uni-th/uni-th.js")+(()=>"../../../uni_modules/uni-table/components/uni-tr/uni-tr.js")+(()=>"../../../uni_modules/uni-table/components/uni-td/uni-td.js")+(()=>"../../../uni_modules/uni-link/components/uni-link/uni-link.js")+(()=>"../../../uni_modules/uni-tag/components/uni-tag/uni-tag.js")+(()=>"../../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../../uni_modules/uni-table/components/uni-table/uni-table.js")+(()=>"../../../uni_modules/uni-pagination/components/uni-pagination/uni-pagination.js")+(()=>"../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js")+(()=>"../../../components/fix-window/fix-window.js")+(()=>"../../../uni_modules/uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const s=e._export_sfc(o,[["render",function(t,a,i,n,o,s){return{a:e.o(((...e)=>s.search&&s.search(...e))),b:t.$t("common.placeholder.query"),c:o.query,d:e.o((e=>o.query=e.detail.value)),e:e.t(t.$t("common.button.search")),f:e.o(((...e)=>s.search&&s.search(...e))),g:e.t(t.$t("common.button.add")),h:e.o((e=>s.navigateTo("./add"))),i:e.t(t.$t("common.button.batchDelete")),j:!o.selectedIndexs.length,k:e.o(((...e)=>s.delTable&&s.delTable(...e))),l:e.t(t.$t("common.button.tagManager")),m:!o.selectedIndexs.length,n:e.o(((...e)=>s.openTagsPopup&&s.openTagsPopup(...e))),o:e.w((({data:a,pagination:i,loading:n,error:b,options:l},r,d)=>({a:"4bbb09b1-4-"+d+",4bbb09b1-3-"+d,b:"4bbb09b1-5-"+d+",4bbb09b1-3-"+d,c:"4bbb09b1-6-"+d+",4bbb09b1-3-"+d,d:"4bbb09b1-7-"+d+",4bbb09b1-3-"+d,e:e.p({align:"center","filter-type":"select","filter-data":l.filterData.status_localdata}),f:"4bbb09b1-8-"+d+",4bbb09b1-3-"+d,g:"4bbb09b1-9-"+d+",4bbb09b1-3-"+d,h:"4bbb09b1-10-"+d+",4bbb09b1-3-"+d,i:"4bbb09b1-11-"+d+",4bbb09b1-3-"+d,j:"4bbb09b1-12-"+d+",4bbb09b1-3-"+d,k:"4bbb09b1-13-"+d+",4bbb09b1-3-"+d,l:"4bbb09b1-3-"+d+",4bbb09b1-2-"+d,m:e.f(a,((t,a,i)=>e.e({a:e.t(t.username),b:"4bbb09b1-15-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,c:e.t(t.nickname),d:"4bbb09b1-16-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,e:e.t(t.mobile),f:"4bbb09b1-17-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,g:e.t(l.status_valuetotext[t.status]),h:"4bbb09b1-18-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,i:"4bbb09b1-20-"+d+"-"+i+",4bbb09b1-19-"+d+"-"+i,j:e.p({href:"mailto:"+t.email,text:t.email}),k:"4bbb09b1-19-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,l:e.t(t.role),m:"4bbb09b1-21-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,n:e.f(t.tags,((a,n,o)=>e.e(t.tags?{a:"4bbb09b1-23-"+d+"-"+i+"-"+o+",4bbb09b1-22-"+d+"-"+i,b:e.p({type:"primary",inverted:!0,size:"small",text:a})}:{},{c:n}))),o:t.tags,p:"4bbb09b1-22-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,q:void 0===t.dcloud_appid},void 0===t.dcloud_appid?{r:"4bbb09b1-25-"+d+"-"+i+",4bbb09b1-24-"+d+"-"+i,s:e.p({href:o.noAppidWhatShouldIDoLink})}:{},{t:e.t(t.dcloud_appid),v:"4bbb09b1-24-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,w:"4bbb09b1-27-"+d+"-"+i+",4bbb09b1-26-"+d+"-"+i,x:e.p({threshold:[0,0],date:t.last_login_date}),y:"4bbb09b1-26-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,z:e.o((e=>s.navigateTo("./edit?id="+t._id,!1)),a),A:e.o((e=>s.confirmDelete(t._id)),a),B:"4bbb09b1-28-"+d+"-"+i+",4bbb09b1-14-"+d+"-"+i,C:a,D:"4bbb09b1-14-"+d+"-"+i+",4bbb09b1-2-"+d}))),n:e.sr("table","4bbb09b1-2-"+d+",4bbb09b1-1"),o:"4bbb09b1-2-"+d+",4bbb09b1-1",p:e.p({loading:n,emptyText:b.message||t.$t("common.empty"),border:!0,stripe:!0,type:"selection"}),q:"4bbb09b1-29-"+d+",4bbb09b1-1",r:e.o((e=>i.current=e)),s:e.p({"show-iconn":!0,"show-page-size":!0,"page-size":i.size,total:i.count,modelValue:i.current}),t:d,v:r})),{name:"d",path:"o",vueId:"4bbb09b1-1"}),p:e.o((e=>s.filterChange(e,"username"))),q:e.o((e=>s.sortChange(e,"username"))),r:e.p({align:"center","filter-type":"search",sortable:!0}),s:e.o((e=>s.filterChange(e,"nickname"))),t:e.o((e=>s.sortChange(e,"nickname"))),v:e.p({align:"center","filter-type":"search",sortable:!0}),w:e.o((e=>s.filterChange(e,"mobile"))),x:e.o((e=>s.sortChange(e,"mobile"))),y:e.p({align:"center","filter-type":"search",sortable:!0}),z:e.o((e=>s.filterChange(e,"status"))),A:e.o((e=>s.filterChange(e,"email"))),B:e.o((e=>s.sortChange(e,"email"))),C:e.p({align:"center","filter-type":"search",sortable:!0}),D:e.p({align:"center"}),E:e.o((e=>s.filterChange(e,"tags"))),F:e.p({align:"center","filter-type":"select","filter-data":s.tagsData}),G:e.p({align:"center"}),H:e.o((e=>s.filterChange(e,"last_login_date"))),I:e.o((e=>s.sortChange(e,"last_login_date"))),J:e.p({align:"center","filter-type":"timestamp",sortable:!0}),K:e.p({align:"center"}),L:e.p({align:"center"}),M:e.p({align:"center"}),N:e.p({align:"center"}),O:e.p({align:"center"}),P:e.p({align:"center"}),Q:e.p({align:"center"}),R:e.p({align:"center"}),S:e.p({align:"center"}),T:e.p({align:"center"}),U:e.t(t.$t("common.button.edit")),V:e.t(t.$t("common.button.delete")),W:e.p({align:"center"}),X:e.o(s.selectionChange),Y:e.o(s.onPageChanged),Z:e.o(s.changeSize),aa:e.sr("udb","4bbb09b1-1"),ab:e.o(s.onqueryload),ac:e.p({collection:o.collectionList,where:o.where,"page-data":"replace",orderby:o.orderby,getcount:!0,"page-size":o.options.pageSize,"page-current":o.options.pageCurrent,options:o.options,loadtime:"manual"}),ad:e.sr("checkbox","4bbb09b1-32,4bbb09b1-31"),ae:e.o((e=>o.managerTags=e)),af:e.p({multiple:!0,collection:"uni-id-tag",field:"tagid as value, name as text",modelValue:o.managerTags}),ag:e.o(((...e)=>s.managerMultiTag&&s.managerMultiTag(...e))),ah:e.sr("tagsPopup","4bbb09b1-31"),ai:e.p({type:"center"})}}]]);wx.createPage(s);
