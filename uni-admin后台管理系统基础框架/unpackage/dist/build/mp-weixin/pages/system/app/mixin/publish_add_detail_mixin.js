"use strict";const e=require("../../../../common/vendor.js"),t=require("../../../../js_sdk/validator/opendb-app-list.js"),a=e=>e?{name:"",extname:"",url:e}:{};function i(e){let a={};for(let i in t.validator)e.includes(i)&&(a[i]=t.validator[i]);return a}const o=["mimarket","samsungapps","appmarket","oppomarket","vivomarket"],s=["xiaomi","samsung","huawei","oppo","vivo"],r={data(){let e={appid:"",name:"",icon_url:"",introduction:"",alias:"",description:"",screenshot:[],store_list:[],app_android:{},app_ios:{},app_harmony:{},mp_weixin:{},mp_alipay:{},mp_baidu:{},mp_toutiao:{},mp_qq:{},mp_lark:{},mp_kuaishou:{},mp_dingtalk:{},mp_jd:{},h5:{},quickapp:{}};const a={formData:e,rules:Object.freeze(i(Object.keys(e))),mpPlatform:Object.freeze(t.mpPlatform),screenshotList:[],middleware_img:{},middleware_checkbox:{},appPackageInfo:{},appPlatformKeys:Object.freeze(["app_ios","app_android","app_harmony"]),appPlatformValues:Object.freeze({app_android:"Android",app_ios:"iOS",app_harmony:"Harmony"}),keepItems:Object.freeze([]),isEdit:!1,deletedStore:[]},o=Object.keys(t.mpPlatform);return a.mpPlatformKeys=Object.freeze(o),[].concat(o,["icon_url","quickapp"]).forEach((e=>a.middleware_img[e]={})),a.platFormKeys=Object.freeze([].concat(o,a.appPlatformKeys)),a.platFormKeys.forEach((e=>a.middleware_checkbox[e]=!1)),a},methods:{requestCloudFunction(e,t={}){return this.$request(e,t,{functionName:"uni-upgrade-center"})},hasValue:e=>"object"!=typeof e?!!e:e instanceof Array?!!e.length:!(!e||!Object.keys(e).length),initFormData(e){if(e&&Object.keys(e).length)for(let t in e){const i=e[t];switch(t){case"icon_url":this.middleware_img[t]=a(i);break;case"screenshot":this.screenshotList=i.map((e=>a(e)));break;default:-1===t.indexOf("mp")&&-1===t.indexOf("app")||!this.hasValue(i)||(this.setPlatformChcekbox(t,!0),i.qrcode_url&&(this.middleware_img[t]=a(i.qrcode_url)))}this.setFormData(t,i)}},setFormData(e,t){const a=-1!==e.indexOf(".")?e.split("."):[e],i=a.length-1;let o=this.formData;a.forEach(((e,a)=>{const s=o[e];"object"==typeof s&&a<i?o=s:o[e]=t}))},getFormData(e){const t=-1!==e.indexOf(".")?e.split("."):[e];t.length;let a=this.formData;for(let i=0;i<t.length;i++){if(a=a[t[i]],null==a)return!1}return a},formatFormData(){this.setFormData("screenshot",this.screenshotList.map((e=>e.fileID||e.url)));for(let e=0;e<this.formData.store_list.length;e++){const t=this.formData.store_list[e];if(0===t.scheme.trim().length){this.formData.store_list.splice(e,1),e--;continue}const a=o.indexOf((t.scheme.match(/(.*):\/\//)||[])[1]);-1!==a&&(t.id!==s[a]&&this.deletedStore.push(t.id),t.id=s[a]),t.priority=parseFloat(t.priority)}this.keepItems=this.platFormKeys.filter((e=>this.getPlatformChcekbox(e)&&(this.formData[e].url||this.formData[e].abm_url||this.formData[e].qrcode_url))).concat(["icon_url","screenshot","create_date","store_list"]),this.formData.h5&&this.formData.h5.url&&this.keepItems.push("h5")},autoFill(){const t=this.getFormData("appid");t&&(e.index.showLoading({mask:!0}),this.requestCloudFunction("getAppInfo",{appid:t}).then((e=>{if(e.success)return this.setFormData("description",e.description),void this.setFormData("name",e.name)})).catch((e=>{console.error(e)})).finally((()=>{e.index.hideLoading()})))},autoFillApp(){const e=this.getFormData("appid");e&&this.appPlatformKeys.forEach((t=>{this.fetchAppInfo(e,this.appPlatformValues[t]).then((e=>{if(e&&e.success)return this.setPlatformChcekbox(t,!0),void this.setFormData(t,{name:e.name,url:e.url})}))}))},fetchAppInfo(t,a){return e.index.showLoading({mask:!0}),this.requestCloudFunction("getAppVersionInfo",{appid:t,platform:a}).then((e=>e)).catch((e=>{console.error(e)})).finally((()=>{e.index.hideLoading()}))},iconUrlSuccess(t,a){e.index.showToast({icon:"success",title:"上传成功",duration:500}),this.setFormData(a,t.tempFilePaths[0])},async iconUrlDelete(t,a){await this.requestCloudFunction("deleteFile",{fileList:[t.tempFile.fileID||t.tempFile.url]}),e.index.showToast({icon:"success",title:"删除成功",duration:800}),a&&(this.setFormData(a,""),this.$refs.form.clearValidate(a))},getPlatformChcekbox(e){return this.middleware_checkbox[e]},setPlatformChcekbox(e,t=!1){this.middleware_checkbox[e]=t},selectFile(){this.hasPackage&&e.index.showToast({icon:"none",title:"只可上传一个文件，请删除已上传后重试",duration:1e3})}},computed:{hasPackage(){return this.appPackageInfo&&!!Object.keys(this.appPackageInfo).length}}};exports.mixin=r;
