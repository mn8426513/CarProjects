"use strict";const e=require("../../../common/vendor.js"),t=require("./mixin/publish_add_detail_mixin.js"),i=e.er.database();i.command;function o(e){let t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],i="";for(let o=0;o<e;o++)i+=t[Math.floor(26*Math.random())];return i}const a={mixins:[t.mixin],data:()=>({mpExtra:" ",mpAccordionStatus:1,labelWidth:"80px",uniFilePickerProvider:"unicloud"}),onLoad(t){t.id?(this.isEdit=!0,e.index.setNavigationBarTitle({title:"修改应用"}),this.setFormData("appid",t.id),this.getDetail(t.id)):this.$watch("formData.name",(e=>{this.platFormKeys.forEach((t=>{this.setFormData(`${t}.name`,e)}))}))},onReady(){this.mpExtra="折叠"},methods:{resolvestableVersionStoreList(){const e={},t=[];return this.formData.store_list.forEach(((i,o)=>{t.push(i.id),e[i.id]=o})),this.fetchAppInfo(this.getFormData("appid"),"Android").then((i=>{if(i.success){if(i.store_list){const o={},a=[];i.store_list.forEach(((e,t)=>{a.push(e.id),o[e.id]=t})),t.forEach(((t,r)=>{const s=this.formData.store_list[e[t]];-1===a.indexOf(t)?i.store_list.push(s):(i.store_list[o[t]].name=s.name,i.store_list[o[t]].scheme=s.scheme)}));for(let e=0;e<i.store_list.length;e++){let o=i.store_list[e].id;-1!==this.deletedStore.indexOf(o)&&-1===t.indexOf(o)&&(i.store_list.splice(e,1),e--)}}else i.store_list=this.formData.store_list;return this.updateAppVersion(i._id,{store_list:i.store_list})}}))},updateAppVersion:(e,t)=>i.collection("opendb-app-versions").doc(e).update(t),submit(){e.index.showLoading({mask:!0}),this.formatFormData(),this.$refs.form.validate(this.keepItems).then((e=>this.submitForm(e))).catch((e=>{console.error(e)})).finally((()=>{e.index.hideLoading()}))},submitForm(t){(this.isEdit?this.requestCloudFunction("setNewAppData",{id:this.formDataId,value:t}):i.collection("opendb-app-list").add(t)).then((e=>{if(this.isEdit)return this.resolvestableVersionStoreList()})).then((()=>{e.index.showToast({title:(this.isEdit?"更新":"新增")+"成功"}),this.getOpenerEventChannel().emit("refreshData"),setTimeout((()=>e.index.navigateBack()),500)})).catch((t=>{e.index.showModal({content:t.message||"请求服务失败",showCancel:!1})}))},getDetail(t){e.index.showLoading({mask:!0}),i.collection("opendb-app-list").where({appid:t}).get().then((e=>{const t=e.result.data[0];t?(this.formDataId=t._id,this.initFormData(t)):(this.autoFill(),this.autoFillApp())})).catch((t=>{e.index.showModal({content:t.message||"请求服务失败",showCancel:!1})})).finally((()=>{e.index.hideLoading()}))},mpAccordion(){this.mpAccordionStatus?(this.mpExtra="展开",this.mpAccordionStatus=0):(this.mpExtra="折叠",this.mpAccordionStatus=1)},addStoreScheme(){this.formData.store_list.push({enable:!1,priority:0,id:o(5)+"_"+Date.now()})},deleteStore(t,i){i.scheme&&i.scheme.trim().length&&this.isEdit?e.index.showModal({content:"是否同步删除线上版本此条商店记录？",success:e=>{const i=this.formData.store_list.splice(t,1)[0];i&&e.confirm&&this.deletedStore.push(i.id)}}):this.formData.store_list.splice(t,1)[0]},schemeDemo(){$refs.scheme.open("center")}}};if(!Array){(e.resolveComponent("uni-notice-bar")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-card")+e.resolveComponent("uni-file-picker")+e.resolveComponent("show-info")+e.resolveComponent("uni-popup")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../../uni_modules/uni-notice-bar/components/uni-notice-bar/uni-notice-bar.js")+(()=>"../../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../../components/show-info/show-info.js")+(()=>"../../../uni_modules/uni-popup/components/uni-popup/uni-popup.js")+(()=>"../../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const r=e._export_sfc(a,[["render",function(t,i,o,a,r,s){return e.e({a:e.p({showIcon:!0,text:"本页面信息，在应用发布、app升级模块中，都会关联使用，请认真填写"}),b:e.o((e=>t.formData.appid=e)),c:e.p({disabled:t.isEdit,placeholder:"应用的AppID",trim:"both",modelValue:t.formData.appid}),d:e.p({name:"appid",label:"AppID",required:!0}),e:e.o((e=>t.formData.name=e)),f:e.p({disabled:t.isEdit,placeholder:"应用名称",trim:"both",modelValue:t.formData.name}),g:e.p({name:"name",label:"应用名称",required:!0}),h:e.o((e=>t.formData.introduction=e)),i:e.p({placeholder:"应用简介",trim:"both",modelValue:t.formData.introduction}),j:e.p({name:"introduction",label:"应用简介"}),k:-1,l:e.o([e=>t.formData.description=e.detail.value,e=>t.binddata("description",e.detail.value)]),m:t.formData.description,n:e.p({name:"description",label:"应用描述"}),o:-1,p:e.o([e=>t.formData.remark=e.detail.value,e=>t.binddata("remark",e.detail.value)]),q:t.formData.remark,r:e.p({name:"remark",label:"应用备注"}),s:e.p({title:"基础信息"}),t:e.o((e=>t.iconUrlSuccess(e,"icon_url"))),v:e.o((e=>t.iconUrlDelete(e,"icon_url"))),w:e.o((e=>t.middleware_img.icon_url=e)),x:e.p({"image-styles":{width:"200rpx"},"return-type":"object","file-mediatype":"image",limit:"1",mode:"grid",modelValue:t.middleware_img.icon_url}),y:e.p({label:"应用图标"}),z:e.o(t.iconUrlDelete),A:e.o((e=>t.screenshotList=e)),B:e.p({"file-mediatype":"image",mode:"grid","image-styles":{height:"500rpx",width:"300rpx"},modelValue:t.screenshotList}),C:e.p({label:"应用截图"}),D:e.p({title:"图标素材"}),E:t.isEdit},t.isEdit?{F:e.o(((...e)=>t.autoFillApp&&t.autoFillApp(...e))),G:e.p({left:-10,top:-35,width:"230",content:"从App升级中心同步应用安装包信息"})}:{},{H:e.f(t.appPlatformKeys,((i,o,a)=>e.e({a:i,b:t.middleware_checkbox[i],c:e.t(t.appPlatformValues[i]),d:t.getPlatformChcekbox(i)?1:"",e:e.o((({detail:{value:e}})=>{t.setPlatformChcekbox(i,!!e.length)}),i),f:t.getPlatformChcekbox(i)},t.getPlatformChcekbox(i)?e.e({g:"9bf7d37c-19-"+a+",9bf7d37c-18-"+a,h:e.o((e=>t.formData[i].name=e),i),i:e.p({trim:"both",modelValue:t.formData[i].name}),j:"9bf7d37c-18-"+a+",9bf7d37c-16",k:e.p({label:"名称"}),l:"app_android"===i},"app_android"===i?e.e({m:e.o((e=>this.uniFilePickerProvider=e.detail.value),i),n:e.o(((...e)=>t.selectFile&&t.selectFile(...e)),i),o:e.o((e=>t.iconUrlSuccess(e,`${i}.url`)),i),p:e.o((e=>t.iconUrlDelete(e,`${i}.url`)),i),q:"9bf7d37c-21-"+a+",9bf7d37c-20-"+a,r:e.o((e=>t.appPackageInfo=e),i),s:e.p({"file-extname":"apk",disabled:t.hasPackage,provider:r.uniFilePickerProvider,returnType:"object","file-mediatype":"all",limit:"1",modelValue:t.appPackageInfo}),t:t.hasPackage},t.hasPackage?{v:e.t(t.appPackageInfo.size&&Number(t.appPackageInfo.size/1024/1024).toFixed(2)+"M")}:{},{w:"9bf7d37c-20-"+a+",9bf7d37c-16",x:e.p({label:"上传apk包"})}):{},{y:"9bf7d37c-23-"+a+",9bf7d37c-22-"+a,z:e.o((e=>t.formData[i].url=e),i),A:e.p({maxlength:-1,trim:"both",modelValue:t.formData[i].url}),B:"9bf7d37c-22-"+a+",9bf7d37c-16",C:e.p({label:"app_ios"===i?"AppStore 链接":"下载链接"}),D:"app_ios"===i},"app_ios"===i?{E:"9bf7d37c-25-"+a+",9bf7d37c-24-"+a,F:e.o((e=>t.formData[i].abm_url=e),i),G:e.p({maxlength:-1,trim:"both",modelValue:t.formData[i].abm_url}),H:"9bf7d37c-24-"+a+",9bf7d37c-16",I:e.p({label:"获取 ABM 应用登录链接"})}:{}):{},{J:i}))),I:e.sr("scheme","9bf7d37c-26,9bf7d37c-16"),J:e.p({"background-color":"#fff"}),K:e.o(((...e)=>s.schemeDemo&&s.schemeDemo(...e))),L:e.o(((...e)=>s.addStoreScheme&&s.addStoreScheme(...e))),M:e.f(t.formData.store_list,((t,i,o)=>({a:e.o((e=>s.deleteStore(i,t)),t.id),b:"9bf7d37c-30-"+o+",9bf7d37c-29-"+o,c:e.o((e=>t.name=e),t.id),d:e.p({trim:"both",modelValue:t.name}),e:"9bf7d37c-29-"+o+",9bf7d37c-28-"+o,f:"9bf7d37c-32-"+o+",9bf7d37c-31-"+o,g:e.o((e=>t.scheme=e),t.id),h:e.p({maxlength:-1,trim:"both",modelValue:t.scheme}),i:"9bf7d37c-31-"+o+",9bf7d37c-28-"+o,j:"9bf7d37c-28-"+o+",9bf7d37c-27",k:t.id}))),N:e.p({label:"商店名称"}),O:e.p({label:"Scheme"}),P:e.p({title:""}),Q:e.p({name:"store_schemes",label:"Android应用市场",labelWidth:"120"}),R:e.p({title:"App 信息"}),S:e.f(t.mpPlatformKeys,((i,o,a)=>e.e({a:i,b:t.middleware_checkbox[i],c:e.t(t.mpPlatform[i]),d:t.getPlatformChcekbox(i)?1:"",e:e.o((({detail:{value:e}})=>{t.setPlatformChcekbox(i,!!e.length)}),i),f:r.mpAccordionStatus&&t.getPlatformChcekbox(i)},r.mpAccordionStatus&&t.getPlatformChcekbox(i)?{g:"9bf7d37c-35-"+a+",9bf7d37c-34-"+a,h:e.o((e=>t.formData[i].name=e),i),i:e.p({trim:"both",modelValue:t.formData[i].name}),j:"9bf7d37c-34-"+a+",9bf7d37c-33",k:e.p({label:"名称"}),l:e.o((e=>t.iconUrlSuccess(e,`${i}.qrcode_url`)),i),m:e.o((e=>t.iconUrlDelete(e,`${i}.qrcode_url`)),i),n:"9bf7d37c-37-"+a+",9bf7d37c-36-"+a,o:e.o((e=>t.middleware_img[i]=e),i),p:e.p({"image-styles":{width:"200rpx"},"return-type":"object","file-mediatype":"image",limit:"1",mode:"grid",modelValue:t.middleware_img[i]}),q:"9bf7d37c-36-"+a+",9bf7d37c-33",r:e.p({label:t.mpPlatform[i].slice(-3)+"码"})}:{},{s:i}))),T:e.p({title:"小程序/快应用信息"}),U:e.o((e=>t.formData.h5.url=e)),V:e.p({maxlength:-1,trim:"both",modelValue:t.formData.h5.url}),W:e.p({label:"链接地址"}),X:e.p({title:"web信息"}),Y:t.isEdit},t.isEdit?{Z:e.p({isShadow:!1})}:{},{aa:e.o(((...e)=>s.submit&&s.submit(...e))),ab:e.sr("form","9bf7d37c-1"),ac:e.o((e=>t.formData=e)),ad:e.p({validateTrigger:"bind",labelWidth:r.labelWidth,rules:t.rules,modelValue:t.formData})})}]]);wx.createPage(r);
